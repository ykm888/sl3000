name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      PROFILE: sl3000-emmc
      DTS_NAME: mt7981b-sl3000-emmc
      DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile
      MK_FILE: target/linux/mediatek/image/filogic.mk
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: Cache dl, build_dir, staging_dir
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','**/*.mk','**/*.dts','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 \
            rsync unzip wget git zlib1g-dev file m4

      - name: Force rebuild host toolchain
        run: |
          rm -rf staging_dir/host staging_dir/hostpkg build_dir/host build_dir/hostpkg

      - name: Feeds auto repair
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools and toolchain
        run: |
          make tools/install -j"$(nproc)" V=s
          make toolchain/install -j"$(nproc)" V=s

      - name: Auto-create DTS Makefile if missing
        run: |
          if [ ! -f "$DTS_MK" ]; then
            echo "DTS Makefile 不存在，自动创建"
            mkdir -p "$(dirname "$DTS_MK")"
            echo "dtb-$(CONFIG_ARCH_MEDIATEK) += ${DTS_NAME}.dtb" > "$DTS_MK"
          fi
          if ! grep -q "${DTS_NAME}.dtb" "$DTS_MK"; then
            echo "dtb-$(CONFIG_ARCH_MEDIATEK) += ${DTS_NAME}.dtb" >> "$DTS_MK"
          fi
          echo "DTS Makefile 已对齐"

      - name: Auto-align DTS / mk / profile
        run: |
          echo "=== 自动对齐 DTS / mk / profile 三件套 ==="
          if [ ! -f "$DTS_FILE" ]; then
            echo "DTS 文件不存在：$DTS_FILE"
            exit 1
          fi
          sed -i "s|DEVICE_DTS :=.*|DEVICE_DTS := ${DTS_NAME}|" "$MK_FILE"
          sed -i "s|DEVICE_DTS_DIR :=.*|DEVICE_DTS_DIR := \$(DTS_DIR)/mediatek|" "$MK_FILE"
          sed -i '/^CONFIG_TARGET_/d' .config 2>/dev/null || true
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y" >> .config
          make defconfig
          echo "三件套已完全对齐"

      - name: Patch auto check
        run: |
          PATCH_DIRS=$(ls -d target/linux/mediatek/patches-* 2>/dev/null || true)
          if [ -z "$PATCH_DIRS" ]; then
            echo "无补丁目录，跳过 patch 检查"
            exit 0
          fi
          echo "检查补丁是否能干净应用..."
          find $PATCH_DIRS -name '*.patch' -exec sh -c 'patch -p1 --dry-run -f < "$1"' _ {} \;

      - name: DTS compile check + dtb auto-detect
        run: |
          make target/linux/compile -j"$(nproc)" V=s
          echo "=== 搜索所有 dtb 文件 ==="
          find build_dir -type f -name "*.dtb" || true
          DTB_PATH=$(find build_dir -type f -name "${DTS_NAME}.dtb" | head -n 1 || true)
          if [ -z "$DTB_PATH" ]; then
            echo "DTS 已编译，但未找到 sl3000 相关 dtb"
            exit 1
          fi
          echo "DTS 已编译为 dtb: $DTB_PATH"

      - name: Build firmware with auto-repair
        run: |
          set -e
          build_once() { make -j"$(nproc)" V=s; }
          if ! build_once; then
            echo "构建失败，清理 build_dir 重试"
            rm -rf build_dir
            if ! build_once; then
              echo "再次失败，清理 dl + build_dir + staging_dir + tmp 再试"
              rm -rf dl build_dir staging_dir tmp
              build_once
            fi
          fi

      - name: Verify firmware output
        run: |
          ls -lh "$TARGET_DIR"
          test -s ${TARGET_DIR}/*.bin

      - name: Package firmware outputs
        run: |
          echo "=== 打包固件产物到 TARGET_DIR ==="
          tar -czf "${TARGET_DIR}/sl3000-emmc-firmware.tar.gz" -C "$TARGET_DIR" .
          (cd "$TARGET_DIR" && sha256sum * > firmware-sha256.txt)
          ls -lh "${TARGET_DIR}/"*

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            ${{ env.TARGET_DIR }}/*.bin
            ${{ env.TARGET_DIR }}/*.img
            ${{ env.TARGET_DIR }}/*.dtb
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt
          if-no-files-found: error

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.TARGET_DIR }}/*.bin
            ${{ env.TARGET_DIR }}/*.img
            ${{ env.TARGET_DIR }}/*.dtb
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: SL3000-EMMC Build ${{ github.run_number }}
          body: |
            Profile: sl3000-emmc
            DTS: ${{ env.DTS_FILE }}
            DTS Makefile: ${{ env.DTS_MK }}
            Commit: ${{ github.sha }}

      - name: Pack logs on failure
        if: failure()
        run: |
          mkdir -p logs || true
          tar -czf build-logs.tar.gz logs/

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs.tar.gz
          if-no-files-found: ignore