name: ImmortalWrt SL3000 Flagship Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      BUILD_DIR: /mnt/openwrt
      PROFILE: sl3000-emmc
      TARGET_DIR: /mnt/openwrt/bin/targets/mediatek/filogic
      PATCH_DIR: /mnt/openwrt/target/linux/mediatek/patches-6.6

    steps:
      - name: Prepare /mnt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown $USER:$USER /mnt/openwrt

      - name: Checkout source
        run: |
          git clone --depth=1 -b v24.10 https://github.com/immortalwrt/immortalwrt.git $BUILD_DIR

      - name: Optimize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Cache downloads and build_dir
        uses: actions/cache@v4
        with:
          path: |
            /mnt/openwrt/dl
            /mnt/openwrt/build_dir
          key: ${{ runner.os }}-immortalwrt-${{ github.run_id }}

      - name: Apply router-specific patches (series method)
        run: |
          cd $PATCH_DIR
          ls *.patch | grep -E "dts|mt7981|router|net" > series

      - name: Auto-fix three-piece files
        run: |
          cd "${BUILD_DIR}"
          [ -f .config ] || touch .config
          [ -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts ] || echo "/dts-v1/;" > target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts
          [ -f target/linux/mediatek/image/filogic.mk ] || echo "# filogic mk" > target/linux/mediatek/image/filogic.mk

      - name: Setup feeds
        run: |
          cd "${BUILD_DIR}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools
        run: |
          cd "${BUILD_DIR}"
          make tools/install -j1 V=s

      - name: Build toolchain
        run: |
          cd "${BUILD_DIR}"
          make toolchain/install -j$(nproc) V=s

      - name: Build target
        run: |
          cd "${BUILD_DIR}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${BUILD_DIR}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${BUILD_DIR}"
          make image PROFILE="${PROFILE}" -j$(nproc) V=s || \
          make image PROFILE="${PROFILE}" -j1 V=s

      - name: Verify firmware output
        run: |
          cd "${BUILD_DIR}"
          ls -lh "${TARGET_DIR}" || { echo "‚ùå No firmware found"; exit 1; }
          md5sum "${TARGET_DIR}"/* || true
          sha256sum "${TARGET_DIR}"/* || true
          for bin in "${TARGET_DIR}"/*; do file "$bin"; done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-flagship-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}
            ${{ env.BUILD_DIR }}/logs

      - name: Cleanup build_dir
        if: always()
        run: |
          rm -rf $BUILD_DIR/build_dir
          rm -rf $BUILD_DIR/staging_dir
          df -h
