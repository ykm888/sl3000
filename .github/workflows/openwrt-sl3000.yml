name: Build SL3000-EMMC Firmware (Stable ext4 + Artifact-driven verification)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/boost
          df -h

      - name: Allocate ext4 image dynamically
        run: |
          sudo mkdir -p /mnt/openwrt
          FREE=$(df -m --output=avail / | tail -1)
          SIZE=$((FREE*80/100))
          if [ $SIZE -gt 20000 ]; then SIZE=20000; fi
          echo "Allocating $SIZE MB ext4 image..."
          sudo fallocate -l ${SIZE}M /mnt/openwrt.img
          sudo mkfs.ext4 /mnt/openwrt.img
          sudo mount -o loop /mnt/openwrt.img /mnt/openwrt
          sudo chown -R $USER:$USER /mnt/openwrt
          df -h /mnt/openwrt

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk libncurses5-dev libncursesw5-dev \
            zlib1g-dev libssl-dev wget git python3 unzip rsync file ccache

      - name: Move repo to /mnt/openwrt
        run: |
          rsync -a --exclude='.git' ./ /mnt/openwrt/
          sudo chown -R $USER:$USER /mnt/openwrt

      - name: Cache OpenWrt downloads
        uses: actions/cache@v4
        with:
          path: /mnt/openwrt/dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /mnt/openwrt/.ccache
          key: ${{ runner.os }}-openwrt-ccache
          restore-keys: |
            ${{ runner.os }}-openwrt-ccache

      - name: Enable ccache
        working-directory: /mnt/openwrt
        run: |
          export CCACHE_DIR=/mnt/openwrt/.ccache
          ccache -M 5G || true

      - name: Update and install feeds (fault-tolerant)
        working-directory: /mnt/openwrt
        run: |
          ./scripts/feeds update -a || true
          ./scripts/feeds install -a || true

      - name: Copy three-piece from repo
        run: |
          cp -f $GITHUB_WORKSPACE/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts \
                /mnt/openwrt/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/
          cp -f $GITHUB_WORKSPACE/target/linux/mediatek/image/filogic.mk \
                /mnt/openwrt/target/linux/mediatek/image/filogic.mk
          cp -f $GITHUB_WORKSPACE/.config /mnt/openwrt/.config

      - name: Minimal semantic check (slice + presence)
        working-directory: /mnt/openwrt
        run: |
          set -euo pipefail
          MK=target/linux/mediatek/image/filogic.mk
          DTS=target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts

          test -f "$DTS" || { echo "âŒ DTS ç¼ºå¤±: $DTS"; exit 1; }
          sed -n '/^define Device\/sl3000-emmc/,/endef/p' "$MK" > .device_block.txt || true
          if ! grep -q '^define Device/sl3000-emmc' .device_block.txt; then
            echo "âŒ è®¾å¤‡æ®µç¼ºå¤±: define Device/sl3000-emmc"; exit 1
          fi

          # åªåšå­˜åœ¨æ€§åˆ¤æ–­ï¼Œé¿å…æ ¼å¼å·®å¼‚è¯¯åˆ¤ï¼›å¤±è´¥æ—¶æ‰“å°è¯Šæ–­
          if ! grep -Fq "DEVICE_DTS" .device_block.txt; then
            echo "âŒ è®¾å¤‡æ®µå†…æœªå‘ç° DEVICE_DTS"; cat .device_block.txt; exit 1
          fi
          if ! grep -Fq "mt7981b-sl3000-emmc" .device_block.txt; then
            echo "âŒ è®¾å¤‡æ®µå†…æœªå‘ç°æœŸæœ› DTS åç§° mt7981b-sl3000-emmc"; cat .device_block.txt; exit 1
          fi
          if ! grep -Fq "sl3000-emmc" "$MK"; then
            echo "âŒ å…¨å±€æœªå‘ç° sl3000-emmc å¼•ç”¨ï¼ˆæ£€æŸ¥ TARGET_DEVICESï¼‰"; exit 1
          fi
          grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config || {
            echo "âŒ .config æœªé€‰ä¸­è®¾å¤‡"; exit 1
          }
          echo "âœ… è®¾å¤‡æ®µå­˜åœ¨ä¸”åŒ…å«æœŸæœ› DTS åç§°ä¸ TARGET_DEVICES"

      - name: Generate noninteractive config (defconfig)
        working-directory: /mnt/openwrt
        run: |
          export TERM=xterm
          unset KCONFIG_NOSILENTUPDATE
          make defconfig V=s
          grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config || {
            echo "âŒ defconfig åè®¾å¤‡ä¸¢å¤±"; exit 1
          }
          echo "âœ… defconfig åè®¾å¤‡ä»ç„¶ä¿ç•™"

      - name: Build tools
        working-directory: /mnt/openwrt
        run: make tools/install -j2 V=s IGNORE_ERRORS=m || make tools/install -j1 V=s IGNORE_ERRORS=m

      - name: Build toolchain
        working-directory: /mnt/openwrt
        run: make toolchain/install -j2 V=s IGNORE_ERRORS=m || make toolchain/install -j1 V=s IGNORE_ERRORS=m

      - name: Build target
        working-directory: /mnt/openwrt
        run: make target/compile -j2 V=s IGNORE_ERRORS=m || make target/compile -j1 V=s IGNORE_ERRORS=m

      - name: Build packages
        working-directory: /mnt/openwrt
        run: make package/compile -j2 V=s IGNORE_ERRORS=m || make package/compile -j1 V=s IGNORE_ERRORS=m

      - name: Build firmware (final stage)
        working-directory: /mnt/openwrt
        run: |
          make -j2 V=s IGNORE_ERRORS=m || {
            echo "âš ï¸ å¹¶è¡Œå¤±è´¥ï¼Œæ¸…ç† dl/ å¹¶å•çº¿ç¨‹é‡è¯•..."
            rm -rf dl/* || true
            make -j1 V=s IGNORE_ERRORS=m
          }

      - name: Check firmware output (artifact-driven)
        working-directory: /mnt/openwrt
        run: |
          set -e
          echo "ğŸ” åˆ—å‡º targets ç›®å½•ç»“æ„ï¼ˆä¾¿äºè¯Šæ–­ï¼‰"
          find bin/targets -maxdepth 3 -type d -print || true
          FIRMWARE=$(find bin/targets -type f -name "*sl3000-emmc*sysupgrade*.bin" -o -name "*sl3000-emmc*.bin" || true)
          if [ -z "$FIRMWARE" ]; then
            echo "âŒ æœªå‘ç°åŒ…å« sl3000-emmc çš„å›ºä»¶äº§ç‰©"
            echo "â€”â€” å¯é€‰è¯Šæ–­ï¼šåˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„ bin æ–‡ä»¶ â€”â€”"
            find bin/targets -type f -name "*.bin" -print || true
            exit 1
          else
            echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸ:"
            echo "$FIRMWARE"
          fi

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.bin
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.manifest
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.buildinfo
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.json