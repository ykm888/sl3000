name: ImmortalWrt Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  DTS_NAME: mt7981b-sl3000-emmc

  # 默认路径（旧路径，自动修复会覆盖）
  DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
  DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile

  MK_FILE: target/linux/mediatek/image/filogic.mk
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: /mnt/openwrt
  CCACHE_DIR: /mnt/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # 自动检测 + 自动修复 DTS 路径（核心增强）
      # ---------------------------------------------------------
      - name: Auto Detect & Fix DTS Path
        run: |
          echo "=== Auto Detecting DTS Path ==="

          # 正确路径（filogic）
          CORRECT_DTS="target/linux/mediatek/files-6.12/filogic/arch/arm64/boot/dts/mediatek/${{ env.DTS_NAME }}.dts"
          CORRECT_DTS_MK="target/linux/mediatek/files-6.12/filogic/arch/arm64/boot/dts/mediatek/Makefile"

          # 旧路径（错误路径）
          OLD_DTS="${{ env.DTS_FILE }}"
          OLD_DTS_MK="${{ env.DTS_MK }}"

          # 自动修复 DTS_FILE
          if [ -f "$CORRECT_DTS" ]; then
            echo "Found correct DTS at: $CORRECT_DTS"
            echo "DTS_FILE=$CORRECT_DTS" >> $GITHUB_ENV
          else
            echo "ERROR: DTS not found at correct path!"
            echo "Expected: $CORRECT_DTS"
            exit 1
          fi

          # 自动修复 DTS_MK
          if [ -f "$CORRECT_DTS_MK" ]; then
            echo "Found correct DTS_MK at: $CORRECT_DTS_MK"
            echo "DTS_MK=$CORRECT_DTS_MK" >> $GITHUB_ENV
          else
            echo "ERROR: DTS_MK not found at correct path!"
            echo "Expected: $CORRECT_DTS_MK"
            exit 1
          fi

          echo "=== DTS Path Auto-Fix Completed ==="
          echo "Final DTS_FILE: $CORRECT_DTS"
          echo "Final DTS_MK:   $CORRECT_DTS_MK"

      # ---------------------------------------------------------
      # Pre-build Disk Optimization
      # ---------------------------------------------------------
      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Move source to /mnt
        run: |
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo rsync -a --delete . ${{ env.BUILD_DIR }}
          sudo chown -R $USER:$USER ${{ env.BUILD_DIR }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git \
            ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          sudo mkdir -p ${{ env.CCACHE_DIR }}
          sudo chown $USER:$USER ${{ env.CCACHE_DIR }}
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          ccache --max-size=5G
          ccache -z
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ env.PROFILE }}-${{ github.run_id }}
          restore-keys: |
            immortalwrt-${{ env.PROFILE }}-

      # ---------------------------------------------------------
      # DTS 清理 + 语法校验
      # ---------------------------------------------------------
      - name: Clean & Validate DTS File
        run: |
          cd ${{ env.BUILD_DIR }}

          echo "Using DTS_FILE=${{ env.DTS_FILE }}"

          sed -i '1s/^\xEF\xBB\xBF//' "${{ env.DTS_FILE }}" || true
          sed -i 's/\r//g' "${{ env.DTS_FILE }}" || true
          tr -d '\000-\010\013\014\016-\037' < "${{ env.DTS_FILE }}" > "${{ env.DTS_FILE }}.clean"
          mv "${{ env.DTS_FILE }}.clean" "${{ env.DTS_FILE }}"

          echo "=== DTS Header Check (First 15 Lines) ==="
          head -15 "${{ env.DTS_FILE }}"

          echo "=== Validating DTS Syntax ==="
          if ! dtc -I dts -O dtb -o /dev/null "${{ env.DTS_FILE }}"; then
            echo "ERROR: DTS Syntax Error!"
            exit 1
          fi
          echo "DTS Syntax Check Passed"

      # ---------------------------------------------------------
      # 三件套一致性检查
      # ---------------------------------------------------------
      - name: Full 3-piece Consistency Check & Auto-fix
        run: |
          cd ${{ env.BUILD_DIR }}
          set -e

          echo "=== Checking DTS File Exists ==="
          test -f "${{ env.DTS_FILE }}" || { echo "DTS Missing"; exit 1; }

          echo "=== Checking MK File Exists ==="
          test -f "${{ env.MK_FILE }}" || { echo "MK Missing"; exit 1; }

          echo "=== Checking DTS_MK Exists ==="
          test -f "${{ env.DTS_MK }}" || { echo "DTS_MK Missing"; exit 1; }

          echo "=== Checking MK Device Definition ==="
          grep -q "define Device/${{ env.PROFILE }}" "${{ env.MK_FILE }}" || exit 1

          echo "=== Checking DEVICE_DTS ==="
          grep -q "DEVICE_DTS := ${{ env.DTS_NAME }}" "${{ env.MK_FILE }}" || exit 1

          echo "=== Checking DTS_MK dtb-y Entry ==="
          grep -q "dtb-y += ${{ env.DTS_NAME }}.dtb" "${{ env.DTS_MK }}" || \
            echo "dtb-y += ${{ env.DTS_NAME }}.dtb" >> "${{ env.DTS_MK }}"

          echo "=== 3-piece Check Passed ==="

      # ---------------------------------------------------------
      # 后续构建步骤（保持不变）
      # ---------------------------------------------------------
      - name: Setup Feeds
        run: |
          cd ${{ env.BUILD_DIR }}
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build Tools
        run: |
          cd ${{ env.BUILD_DIR }}
          make tools/install -j2 V=s

      - name: Build Toolchain
        run: |
          cd ${{ env.BUILD_DIR }}
          make toolchain/install -j1 V=s

      - name: Build Target
        run: |
          cd ${{ env.BUILD_DIR }}
          make target/compile -j1 V=s

      - name: Build Packages
        run: |
          cd ${{ env.BUILD_DIR }}
          make package/compile -j2 V=s
          make package/install -j2 V=s
          make package/index

      - name: Build Firmware
        run: |
          cd ${{ env.BUILD_DIR }}
          make -j2 V=s || make -j1 V=s

      - name: Verify Firmware Output
        run: |
          cd ${{ env.BUILD_DIR }}
          ls -lh ${{ env.TARGET_DIR }}/*${{ env.PROFILE }}*
          md5sum ${{ env.TARGET_DIR }}/*${{ env.PROFILE }}*

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}/**/*${{ env.PROFILE }}*
