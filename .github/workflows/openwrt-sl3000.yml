name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      PROFILE: sl3000-emmc
      DTS_NAME: mt7981b-sl3000-emmc
      DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile
      MK_FILE: target/linux/mediatek/image/filogic.mk
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: Cache dl, build_dir, staging_dir
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','**/*.mk','**/*.dts','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 \
            rsync unzip wget git zlib1g-dev file m4 swig libseccomp-dev

      - name: Force rebuild host toolchain
        run: rm -rf staging_dir/host staging_dir/hostpkg build_dir/host build_dir/hostpkg

      - name: Feeds auto repair
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools and toolchain
        run: |
          make tools/install -j"$(nproc)" V=s
          make toolchain/install -j"$(nproc)" V=s

      - name: DTS/mk sanity check
        run: |
          set -euo pipefail
          [ -f "${DTS_FILE}" ] || { echo "❌ Missing ${DTS_FILE}"; exit 1; }
          [ -f "${DTS_MK}" ] || { echo "❌ Missing ${DTS_MK}"; exit 1; }
          [ -f "${MK_FILE}" ] || { echo "❌ Missing ${MK_FILE}"; exit 1; }
          grep -q "${DTS_NAME}.dtb" "${DTS_MK}" || { echo "❌ ${DTS_MK} lacks dtb entry for ${DTS_NAME}"; exit 1; }
          echo "✅ DTS/mk sanity passed"

      - name: Align target profile in .config
        run: |
          sed -i '/^CONFIG_TARGET_/d' .config 2>/dev/null || true
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y" >> .config
          make defconfig

      - name: DTS compile + dtb detect
        run: |
          make target/linux/compile -j"$(nproc)" V=s
          DTB_PATH=$(find build_dir -type f -name "${DTS_NAME}.dtb" | head -n 1 || true)
          [ -n "${DTB_PATH}" ] || { echo "❌ DTS compiled but ${DTS_NAME}.dtb not found"; exit 1; }
          echo "✅ Found dtb: ${DTB_PATH}"

      - name: Build firmware with auto-repair
        run: |
          build_once() { make -j"$(nproc)" V=s; }
          if ! build_once; then
            echo "⚠️ Build failed, clean build_dir and retry"
            rm -rf build_dir
            if ! build_once; then
              echo "⚠️ Build failed again, clean dl+build_dir+staging_dir+tmp and retry"
              rm -rf dl build_dir staging_dir tmp
              build_once
            fi
          fi

      - name: Verify firmware outputs
        run: |
          [ -d "${TARGET_DIR}" ] || { echo "❌ TARGET_DIR not found: ${TARGET_DIR}"; exit 1; }
          ls -lh "${TARGET_DIR}"
          compgen -G "${TARGET_DIR}/*.bin" > /dev/null || { echo "❌ No .bin files"; exit 1; }
          compgen -G "${TARGET_DIR}/*sysupgrade.bin" > /dev/null || { echo "❌ Missing sysupgrade.bin"; exit 1; }
          compgen -G "${TARGET_DIR}/*initramfs-kernel.bin" > /dev/null && echo "ℹ️ initramfs-kernel present"
          compgen -G "${TARGET_DIR}/*initramfs-recovery.bin" > /dev/null && echo "ℹ️ initramfs-recovery present"

      - name: Package firmware outputs
        run: |
          (cd "${TARGET_DIR}" && find . -maxdepth 1 -type f -exec sha256sum {} \; > firmware-sha256.txt)
          tar -czf "${TARGET_DIR}/sl3000-emmc-firmware.tar.gz" -C "${TARGET_DIR}" \
            $(ls ${TARGET_DIR}/*sysupgrade.bin ${TARGET_DIR}/*initramfs-kernel.bin ${TARGET_DIR}/*initramfs-recovery.bin ${TARGET_DIR}/firmware-sha256.txt 2>/dev/null)

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/*initramfs-recovery.bin
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/*initramfs-recovery.bin
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: SL3000-EMMC Build ${{ github.run_number }}
          body: |
            Profile: sl3000-emmc
            DTS: ${{ env.DTS_FILE }}
            DTS Makefile: ${{ env.DTS_MK }}
            Commit: ${{ github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}