name: Build OpenWrt SL3000-EMMC (Enhanced v3)

on:
  workflow_dispatch:
    inputs:
      CLEAN_CACHE:
        description: "Clean build_dir/tmp before build?"
        required: false
        default: "false"
      CLEAN_ALL:
        description: "Clean all caches (dl/staging_dir/build_dir/tmp)?"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Optimize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache \
            /usr/lib/jvm /usr/share/swift /usr/share/miniconda /usr/share/az_* \
            /usr/share/google-cloud-sdk /usr/share/kotlin /usr/share/gradle /usr/share/maven \
            /usr/share/texlive /usr/share/R /usr/share/mono /usr/share/gcc-* \
            /usr/share/locale /usr/share/doc /usr/share/man /usr/share/info \
            /usr/share/icons /usr/share/fonts /usr/share/backgrounds /usr/share/sounds /usr/share/themes
          sudo mkdir -p /mnt/openwrt
          sudo chown $USER:$USER /mnt/openwrt
          rsync -a --delete ./ /mnt/openwrt/
          cd /mnt/openwrt
          df -h /mnt

      - name: Conditionally clean all caches
        if: ${{ github.event.inputs.CLEAN_ALL == 'true' }}
        run: |
          echo "ğŸ§¨ æ¸…ç†æ‰€æœ‰ç¼“å­˜ç›®å½•"
          rm -rf dl build_dir staging_dir tmp

      - name: Conditionally clean build_dir/tmp
        if: ${{ github.event.inputs.CLEAN_CACHE == 'true' }}
        run: |
          echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜ç›®å½• build_dir å’Œ tmp"
          rm -rf build_dir tmp

      - name: Cache OpenWrt build
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
          key: ${{ runner.os }}-openwrt-${{ github.ref_name }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib \
            flex bison gawk gettext libncurses5-dev libncursesw5-dev \
            python3 python3-distutils git unzip wget curl rsync zlib1g-dev libssl-dev \
            libelf-dev m4 jq

      - name: Update feeds
        run: |
          ./scripts/feeds update -a || ./scripts/feeds update -a
          ./scripts/feeds install -a || { rm -rf tmp; ./scripts/feeds install -a; }

      - name: Clean unrelated packages
        run: |
          rm -rf package/utils/audit package/libs/libsemanage package/system/refpolicy \
                 package/system/selinux-policy package/utils/policycoreutils \
                 package/utils/pcat-manager package/utils/lm-sensors \
                 package/emortal/autocore package/emortal/autosamba package/emortal/default-settings \
                 package/feeds/luci/luci-app-samba4 package/feeds/luci/luci-app-lldpd \
                 package/feeds/packages/onionshare-cli package/feeds/packages/python-semanage \
                 package/feeds/packages/selinux-python

      - name: Build host tools
        run: |
          make tools/install -j$(nproc) V=s
          echo "$(pwd)/staging_dir/host/bin" >> $GITHUB_PATH

      - name: Force target device
        run: |
          rm -f .config
          staging_dir/host/bin/config --set-str CONFIG_TARGET_mediatek y
          staging_dir/host/bin/config --set-str CONFIG_TARGET_mediatek_filogic y
          staging_dir/host/bin/config --set-str CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc y
          make defconfig

      - name: Verify three-piece registration
        run: |
          echo "=== DTS Check ==="
          test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts && echo "âœ… DTS OK" || (echo "âŒ DTS MISSING!"; exit 1)
          echo "=== filogic.mk Check ==="
          grep -q '^define Device/sl3000-emmc$' target/linux/mediatek/image/filogic.mk && echo "âœ… filogic.mk OK" || (echo "âŒ MK ENTRY MISSING!"; exit 1)
          echo "=== .config Check ==="
          grep -q 'CONFIG_TARGET.*sl3000-emmc=y' .config && echo "âœ… .config OK" || (echo "âŒ CONFIG MISSING!"; exit 1)

      - name: Build cross toolchain
        run: |
          make toolchain/install -j$(nproc) V=s

      - name: Sanity check toolchain
        run: |
          TOOLDIR=$(echo staging_dir/toolchain-*/bin)
          test -d "$TOOLDIR" || (echo "âŒ Toolchain bin missing"; exit 1)
          for tool in gcc make-ext4fs mkimage mksquashfs; do
            find "$TOOLDIR" -name "*$tool*" | grep -q . || (echo "âŒ Tool $tool missing"; exit 1)
          done

      - name: Optional profiles.json check
        run: |
          echo "=== profiles.json æ£€æŸ¥ï¼ˆéé˜»å¡ï¼‰==="
          make target/linux/compile -j1 V=s || echo "âš ï¸ target/linux ç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡ profiles.json æ£€æŸ¥"
          make package/base-files/compile -j1 V=s || echo "âš ï¸ base-files ç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡ profiles.json æ£€æŸ¥"
          if [ -f tmp/.profiles.json ]; then
            echo "âœ… profiles.json å·²ç”Ÿæˆ"
            grep sl3000 tmp/.profiles.json || echo "âš ï¸ profiles.json ä¸­æœªæ‰¾åˆ° sl3000-emmc"
          else
            echo "âš ï¸ profiles.json ç¼ºå¤±ï¼ˆä¸å½±å“å›ºä»¶ç¼–è¯‘ï¼‰"
          fi
          test -d tmp/.targetinfo && echo "âœ… .targetinfo å­˜åœ¨" || echo "âš ï¸ .targetinfo ç¼ºå¤±"

      - name: Build firmware
        run: |
          set -eo pipefail
          make -j$(nproc) || { echo "âš ï¸ å¹¶è¡Œæ„å»ºå¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•..."; make -j1 V=s; }

      - name: Check firmware output
        run: |
          ls bin/targets/**/sl3000-emmc/*.bin || (echo "âŒ å›ºä»¶æœªç”Ÿæˆ"; exit 1)

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            bin/targets/**/sl3000-emmc/*.bin
            bin/targets/**/sl3000-emmc/*.manifest
            bin/targets/**/sl3000-emmc/*.buildinfo
            bin/targets/**/sl3000-emmc/*.json