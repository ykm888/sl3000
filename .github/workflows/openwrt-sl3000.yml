name: Build SL3000-EMMC Firmware (Stable ext4 mount + Three-Piece Test)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-three-piece:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify three-piece registration
        run: |
          echo "ğŸ” æ£€æŸ¥ .config æ˜¯å¦åŒ…å« sl3000-emmc..."
          if grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config; then
            echo "âœ… .config å·²é€‰ä¸­ sl3000-emmc"
          else
            echo "âŒ .config æœªé€‰ä¸­ sl3000-emmc"
            exit 1
          fi

          echo "ğŸ” æ£€æŸ¥ DTS æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
          if [ -f target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts ]; then
            echo "âœ… DTS æ–‡ä»¶å­˜åœ¨"
          else
            echo "âŒ DTS æ–‡ä»¶ç¼ºå¤±"
            exit 1
          fi

          echo "ğŸ” æ£€æŸ¥ filogic.mk æ˜¯å¦æœ‰å®Œæ•´æ¡ç›®..."
          if grep -q 'Device/sl3000-emmc' target/linux/mediatek/image/filogic.mk; then
            echo "âœ… filogic.mk å·²æ³¨å†Œ sl3000-emmc"
          else
            echo "âŒ filogic.mk æœªæ³¨å†Œ sl3000-emmc"
            exit 1
          fi

          echo "ğŸ” è¿è¡Œ make defconfig å±•å¼€é…ç½®..."
          sudo apt-get update && sudo apt-get install -y build-essential flex bison gawk libncurses5-dev
          make defconfig || true
          if grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config; then
            echo "âœ… defconfig åä»ç„¶ä¿ç•™ sl3000-emmc"
          else
            echo "âŒ defconfig åä¸¢å¤± sl3000-emmc"
            exit 1
          fi

          echo "ğŸ¯ ä¸‰ä»¶å¥—æ£€æŸ¥å®Œæˆ"

  build:
    runs-on: ubuntu-22.04
    needs: test-three-piece
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/boost
          df -h

      - name: Allocate ext4 image dynamically
        run: |
          sudo mkdir -p /mnt/openwrt
          FREE=$(df -m --output=avail / | tail -1)
          SIZE=$((FREE*80/100))
          if [ $SIZE -gt 20000 ]; then SIZE=20000; fi
          echo "Allocating $SIZE MB ext4 image..."
          sudo fallocate -l ${SIZE}M /mnt/openwrt.img
          sudo mkfs.ext4 /mnt/openwrt.img
          sudo mount -o loop /mnt/openwrt.img /mnt/openwrt
          sudo chown -R $USER:$USER /mnt/openwrt
          df -h /mnt/openwrt

      # åç»­æ­¥éª¤ä¿æŒä¸å˜ï¼šç¯å¢ƒå®‰è£…ã€feeds å®¹é”™ã€ä¸‰ä»¶å¥—å¤åˆ¶ã€è‡ªæ„ˆã€defconfigã€åˆ†é˜¶æ®µæ„å»ºã€å›ºä»¶æ£€æµ‹ä¸ä¸Šä¼ 