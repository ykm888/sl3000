name: Build OpenWrt SL3000-EMMC (Final Fix)

on:
  workflow_dispatch:   # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # 磁盘优化 + 移到 /mnt
      - name: Optimize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache \
            /usr/lib/jvm /usr/share/swift /usr/share/miniconda /usr/share/az_* \
            /usr/share/google-cloud-sdk /usr/share/kotlin /usr/share/gradle /usr/share/maven \
            /usr/share/texlive /usr/share/R /usr/share/mono /usr/share/gcc-* \
            /usr/share/locale /usr/share/doc /usr/share/man /usr/share/info \
            /usr/share/icons /usr/share/fonts /usr/share/backgrounds /usr/share/sounds /usr/share/themes
          sudo mkdir -p /mnt/openwrt
          sudo chown $USER:$USER /mnt/openwrt
          rsync -a --delete ./ /mnt/openwrt/
          cd /mnt/openwrt
          df -h /mnt

      # 缓存
      - name: Cache OpenWrt build
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
            tmp
          key: ${{ runner.os }}-openwrt-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-

      # 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib g++-multilib \
            flex bison gawk gettext libncurses5-dev libncursesw5-dev \
            python3 python3-distutils git unzip wget curl rsync zlib1g-dev libssl-dev

      # feeds 自动修复
      - name: Update feeds
        run: |
          ./scripts/feeds update -a || ./scripts/feeds update -a
          ./scripts/feeds install -a || {
            rm -rf tmp
            ./scripts/feeds install -a
          }

      # 自动清理路由器不相关的包
      - name: Auto clean unrelated packages
        run: |
          rm -rf package/utils/audit package/libs/libsemanage package/system/refpolicy \
                 package/system/selinux-policy package/utils/policycoreutils \
                 package/utils/pcat-manager package/utils/lm-sensors \
                 package/emortal/autocore package/emortal/autosamba package/emortal/default-settings \
                 package/feeds/luci/luci-app-samba4 package/feeds/luci/luci-app-lldpd \
                 package/feeds/packages/onionshare-cli package/feeds/packages/python-semanage \
                 package/feeds/packages/selinux-python

      # 强制写入目标设备配置
      - name: Force target device
        run: |
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" >> .config
          make defconfig

      # 三件套验证检测
      - name: Verify three-piece registration
        run: |
          echo "=== DTS Check ==="
          test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts && echo "DTS OK" || echo "DTS MISSING!"
          echo "=== filogic.mk Check ==="
          grep -A10 sl3000-emmc target/linux/mediatek/image/filogic.mk || echo "MK ENTRY MISSING!"
          echo "=== .config Check ==="
          grep sl3000 .config || echo "CONFIG MISSING!"
          echo "=== Targetinfo/Profile Check ==="
          grep sl3000 tmp/.targetinfo || echo "TARGETINFO MISSING!"

      # 强制生成 profiles.json
      - name: Force generate profiles.json
        run: |
          rm -rf tmp
          make defconfig
          make target/linux/compile
          make package/base-files/compile
          test -f tmp/.profiles.json && echo "profiles.json OK" || echo "profiles.json STILL MISSING!"
          grep sl3000 tmp/.profiles.json || echo "PROFILE STILL MISSING!"

      # 构建自动修复
      - name: Build firmware
        run: |
          make -j$(nproc) || {
            echo "Parallel build failed, retrying single job..."
            make -j1 V=s
          }

      # 自动发布固件
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: bin/targets/**/sl3000-emmc/*.bin
