name: ImmortalWrt Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  DTS_NAME: mt7981b-sl3000-emmc
  DTS_FILE: target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts
  MK_FILE: target/linux/mediatek/image/filogic.mk
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: /mnt/openwrt
  CCACHE_DIR: /mnt/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # 0. 自动检测 DTS 路径
      # ---------------------------------------------------------
      - name: Auto Detect & Fix DTS Path
        run: |
          echo "=== Auto Detecting DTS Path ==="
          CORRECT_DTS="target/linux/mediatek/dts/${{ env.DTS_NAME }}.dts"

          if [ -f "$CORRECT_DTS" ]; then
            echo "Found correct DTS at: $CORRECT_DTS"
            echo "DTS_FILE=$CORRECT_DTS" >> $GITHUB_ENV
          else
            echo "ERROR: DTS not found at correct path!"
            echo "Expected: $CORRECT_DTS"
            exit 1
          fi

          echo "=== DTS Path Auto-Fix Completed ==="

      # ---------------------------------------------------------
      # 1. Pre-build Disk Optimization
      # ---------------------------------------------------------
      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Move source to /mnt
        run: |
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo rsync -a --delete . ${{ env.BUILD_DIR }}
          sudo chown -R $USER:$USER ${{ env.BUILD_DIR }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git \
            ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          sudo mkdir -p ${{ env.CCACHE_DIR }}
          sudo chown -R $USER:$USER ${{ env.CCACHE_DIR }}
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          ccache --max-size=5G
          ccache -z
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ env.PROFILE }}-${{ github.run_id }}
          restore-keys: |
            immortalwrt-${{ env.PROFILE }}-

      # ---------------------------------------------------------
      # 2. DTS 清理 + 基础语法校验
      # ---------------------------------------------------------
      - name: Clean & Validate DTS File
        run: |
          cd ${{ env.BUILD_DIR }}

          echo "Using DTS_FILE=${{ env.DTS_FILE }}"

          # 清理 BOM 和 CRLF
          sed -i '1s/^\xEF\xBB\xBF//' "${{ env.DTS_FILE }}" || true
          sed -i 's/\r//g' "${{ env.DTS_FILE }}" || true
          # 强制清理所有控制字符
          LC_ALL=C tr -cd '\11\12\15\40-\176' < "${{ env.DTS_FILE }}" > "${{ env.DTS_FILE }}.clean"
          mv "${{ env.DTS_FILE }}.clean" "${{ env.DTS_FILE }}"

          echo "=== DTS Header Check (First 15 Lines) ==="
          head -15 "${{ env.DTS_FILE }}"

          echo "=== Validating DTS Syntax ==="
          if ! dtc -I dts -O dtb -o /dev/null "${{ env.DTS_FILE }}"; then
            echo "ERROR: DTS Syntax Error!"
            hexdump -C "${{ env.DTS_FILE }}" | head -40
            exit 1
          fi
          echo "✅ DTS Syntax Check Passed"

      # ---------------------------------------------------------
      # 3. DTS 深度分析
      # ---------------------------------------------------------
      - name: Deep DTS Analysis
        run: |
          cd ${{ env.BUILD_DIR }}
          mkdir -p logs/dts

          DTS="${{ env.DTS_FILE }}"
          DTB_OUT="logs/dts/${{ env.DTS_NAME }}.dtb"
          DUMP_DTS="logs/dts/${{ env.DTS_NAME }}.dump.dts"

          echo "=== Rebuild DTB for Analysis ==="
          dtc -I dts -O dtb -o "$DTB_OUT" "$DTS"

          echo "=== Dump DTB Back to DTS ==="
          dtc -I dtb -O dts -o "$DUMP_DTS" "$DTB_OUT"

          echo "=== DTS Include Dependency Check ==="
          grep -E '^#include' "$DTS" || echo "ℹ️ No #include lines found"

          echo "=== DTS Label Duplicate Check ==="
          awk '/:/{print $1}' "$DTS" | sed 's/:$//' | sort | uniq -d > logs/dts/duplicate_labels.txt || true
          if [ -s logs/dts/duplicate_labels.txt ]; then
            echo "⚠️ Duplicate labels detected:"
            cat logs/dts/duplicate_labels.txt
          else
            echo "✅ No duplicate labels"
          fi

          echo "=== DTS Node Path Conflict Check ==="
          grep -E '^[[:space:]][a-zA-Z0-9,_-]+(@[0-9a-fA-Fx]+)?[[:space:]]\{' "$DTS" \
            | sed 's/^[[:space:]]//;s/[[:space:]]\{.*$//' \
            | sort | uniq -d > logs/dts/duplicate_nodes.txt || true
          if [ -s logs/dts/duplicate_nodes.txt ]; then
            echo "⚠️ Duplicate nodes detected:"
            cat logs/dts/duplicate_nodes.txt
          else
            echo "✅ No duplicate nodes"
          fi

      # ---------------------------------------------------------
      # 4. 三件套一致性检查
      # ---------------------------------------------------------
      - name: Full 3-piece Consistency Check & Auto-fix
        run: |
          cd ${{ env.BUILD_DIR }}

          echo "=== Checking DTS File Exists ==="
          test -f "${{ env.DTS_FILE }}" || { echo "❌ DTS Missing"; exit 1; }
          echo "✅ DTS Exists"

          echo "=== Checking MK File Exists ==="
          test -f "${{ env.MK_FILE }}" || { echo "❌ MK Missing"; exit 1; }
          echo "✅ MK Exists"

          echo "=== Checking MK Device Definition ==="
          grep -q "define Device/${{ env.PROFILE }}" "${{ env.MK_FILE }}" \
            || { echo "❌ Device not defined in MK"; exit 1; }
          echo "✅ Device Definition Exists"

          echo "=== Checking DEVICE_DTS Alignment ==="
          grep -q "DEVICE_DTS := ${{ env.DTS_NAME }}" "${{ env.MK_FILE }}" \
            || { echo "❌ DEVICE_DTS mismatch"; exit 1; }
          echo "✅ DEVICE_DTS Aligned"

          echo "=== Checking DEVICE_DTS_DIR ==="
          grep -q "DEVICE_DTS_DIR := target/linux/mediatek/dts" "${{ env.MK_FILE }}" \
            || { echo "❌ DEVICE_DTS_DIR mismatch"; exit 1; }
          echo "✅ DEVICE_DTS_DIR Aligned"

      # ---------------------------------------------------------
      # 5. Build 全链路
      # ---------------------------------------------------------
      - name: Setup Feeds
        run: |
          cd ${{ env.BUILD_DIR }}
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build Tools
        run: |
          cd ${{ env.BUILD_DIR }}
          make tools/install -j$(nproc) V=s

      - name: Build Toolchain
        run: |
          cd ${{ env.BUILD_DIR }}
          make toolchain/install -j$(nproc) V=s

      - name: Build Target
        run: |
          cd ${{ env.BUILD_DIR }}
          make target/compile -j$(nproc) V=s

      - name: Build Packages
        run: |
          cd ${{ env.BUILD_DIR }}
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build Firmware
        run: |
          cd ${{ env.BUILD_DIR }}
          make image PROFILE=${{ env.PROFILE }} -j$(nproc) V=s || make image PROFILE=${{ env.PROFILE }} -j1 V=s

      - name: Verify Firmware Output
        run: |
          cd ${{ env.BUILD_DIR }}
          echo "=== Firmware List ==="
          ls -lh ${{ env.TARGET_DIR }}/${{ env.PROFILE }} || { echo "❌ No Firmware Found"; exit 1; }
          echo -e "\n=== MD5 Checksum ==="
          md5sum ${{ env.TARGET_DIR }}/${{ env.PROFILE }}/* || true
          echo -e "\n=== File Type Check ==="
          for bin in ${{ env.TARGET_DIR }}/${{ env.PROFILE }}/*; do
            file $bin || true
          done
          echo "✅ Firmware Validation Passed"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}/${{ env.PROFILE }}
            ${{ env.BUILD_DIR }}/logs/dts/*
