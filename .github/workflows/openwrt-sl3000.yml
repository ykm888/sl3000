name: ImmortalWrt SL3000 Build 24.10

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: openwrt
  CCACHE_DIR: ccache
  PROFILE: sl3000-emmc
  DTSFILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
  PATCHFILE: target/linux/mediatek/patches-6.12/117-complete-mt7981b-dtsi.patch

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ---------------------------------------------------------
      # 0. 克隆官方源码
      # ---------------------------------------------------------
      - name: Clone ImmortalWrt 24.10
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git "${{ env.BUILD_DIR }}"
          cd "${{ env.BUILD_DIR }}"
          git checkout openwrt-24.10

      # ---------------------------------------------------------
      # 1. 构建环境
      # ---------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev \
            file wget curl git ccache time pkg-config libelf-dev \
            rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          echo "CCACHEDIR=${{ env.CCACHE_DIR }}" >> "$GITHUB_ENV"
          export CCACHEDIR="${{ env.CCACHE_DIR }}"
          ccache --max-size=5G
          ccache -z

      # ---------------------------------------------------------
      # 2. 补丁清理，只保留 117
      # ---------------------------------------------------------
      - name: Clean patches, keep only 117
        run: |
          cd "${{ env.BUILD_DIR }}/target/linux/mediatek/patches-6.12"
          ls | grep -v "117-complete-mt7981b-dtsi.patch" | xargs -r rm -f
          echo "Remaining patches:"
          ls

      # ---------------------------------------------------------
      # 3. 三件套覆盖
      # ---------------------------------------------------------
      - name: Override 3-piece dt-bindings
        run: |
          cp -f include/dt-bindings/clock/mt7981-clk.h "${{ env.BUILD_DIR }}/include/dt-bindings/clock/"
          cp -f include/dt-bindings/reset/mt7981-reset.h "${{ env.BUILD_DIR }}/include/dt-bindings/reset/"
          cp -f include/dt-bindings/pinctrl/mt7981-pinfunc.h "${{ env.BUILD_DIR }}/include/dt-bindings/pinctrl/"
          echo "✅ 三件套已覆盖到官方源码"

      # ---------------------------------------------------------
      # 4. Fail-fast 检查
      # ---------------------------------------------------------
      - name: Pre-build fail-fast check
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== [三件套文件检查] ==="
          test -f include/dt-bindings/clock/mt7981-clk.h || { echo "❌ 缺少 mt7981-clk.h"; exit 1; }
          test -f include/dt-bindings/reset/mt7981-reset.h || { echo "❌ 缺少 mt7981-reset.h"; exit 1; }
          test -f include/dt-bindings/pinctrl/mt7981-pinfunc.h || { echo "❌ 缺少 mt7981-pinfunc.h"; exit 1; }
          echo "✅ 三件套文件存在"

          echo "=== [DTS 编译验证] ==="
          mkdir -p logs/dts
          dtc -I dts -O dtb -o logs/dts/precheck.dtb "${{ env.DTSFILE }}" || { echo "❌ DTS 编译失败"; exit 1; }
          echo "✅ DTS 编译通过"

      # ---------------------------------------------------------
      # 5. Feeds & 工具链
      # ---------------------------------------------------------
      - name: Setup feeds
        run: |
          cd "${{ env.BUILD_DIR }}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools
        run: |
          cd "${{ env.BUILD_DIR }}"
          make tools/install -j$(nproc) V=s

      - name: Build toolchain
        run: |
          cd "${{ env.BUILD_DIR }}"
          make toolchain/install -j$(nproc) V=s

      # ---------------------------------------------------------
      # 6. Target & Packages & Image
      # ---------------------------------------------------------
      - name: Build target
        run: |
          cd "${{ env.BUILD_DIR }}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${{ env.BUILD_DIR }}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${{ env.BUILD_DIR }}"
          make image PROFILE="${{ env.PROFILE }}" -j$(nproc) V=s || \
          make image PROFILE="${{ env.PROFILE }}" -j1 V=s

      # ---------------------------------------------------------
      # 7. 固件验证 + 自动注册产物
      # ---------------------------------------------------------
      - name: Verify firmware output
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== [Firmware List] ==="
          ls -lh "${{ env.TARGET_DIR }}" || { echo "❌ No firmware found"; exit 1; }
          echo "=== [MD5 Checksum] ==="
          md5sum "${{ env.TARGET_DIR }}"/* || true
          echo "=== [SHA256 Checksum] ==="
          sha256sum "${{ env.TARGET_DIR }}"/* || true
          echo "=== [File Type Check] ==="
          for bin in "${{ env.TARGET_DIR }}"/*; do
            file "$bin" || true
          done
          echo "✅ Firmware validation passed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}
            ${{ env.BUILD_DIR }}/logs/dts
