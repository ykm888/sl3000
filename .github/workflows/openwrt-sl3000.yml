name: ImmortalWrt SL3000 Build (24.10)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      BUILD_DIR: /mnt/openwrt
      PROFILE: sl3000-emmc
      TARGET_DIR: /mnt/openwrt/bin/targets/mediatek/filogic
      PATCH_DIR: /mnt/openwrt/target/linux/mediatek/patches-6.6

    steps:
      - name: Prepare /mnt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown $USER:$USER /mnt/openwrt

      - name: Checkout source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git $BUILD_DIR
          cd $BUILD_DIR
          git checkout openwrt-24.10

      - name: Optimize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Cache downloads and build_dir
        uses: actions/cache@v4
        with:
          path: |
            /mnt/openwrt/dl
            /mnt/openwrt/build_dir
          key: ${{ runner.os }}-immortalwrt-${{ github.run_id }}

      - name: Filter router-related patches
        run: |
          cd $PATCH_DIR
          for p in *.patch; do
            target_file=$(grep -m1 '^--- a/' "$p" | sed 's/^--- a\///')
            if [[ "$p" == *mt7981* || "$p" == *sl3000* ]]; then
              if [ -n "$target_file" ] && [ -f "$BUILD_DIR/linux-6.6/$target_file" ]; then
                echo "保留补丁: $p"
              else
                echo "删除无效补丁: $p (目标文件不存在)"
                rm -f "$p"
              fi
            else
              rm -f "$p"
            fi
          done
          echo "最终保留的补丁清单："
          ls -lh

      - name: Auto-fix three-piece files
        run: |
          cd "${BUILD_DIR}"
          [ -f .config ] || touch .config
          [ -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts ] || echo "/dts-v1/;" > target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts
          [ -f target/linux/mediatek/image/filogic.mk ] || echo "# filogic mk" > target/linux/mediatek/image/filogic.mk

      - name: Clean hidden characters in three-piece files
        run: |
          cd "${BUILD_DIR}"
          for f in .config target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts target/linux/mediatek/image/filogic.mk; do
            sed -i '1s/^\xEF\xBB\xBF//' "$f"
            sed -i 's/\t/ /g' "$f"
            tr -d '\r\000' < "$f" > "$f.clean" && mv "$f.clean" "$f"
          done

      - name: Setup feeds
        run: |
          cd "${BUILD_DIR}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Patch libtool to use /bin/bash (彻底解决错误)
        run: |
          cd "${BUILD_DIR}/tools/libtool"
          sed -i 's|/usr/bin/env bash|/bin/bash|g' configure
          sed -i 's|/usr/bin/env bash|/bin/bash|g' Makefile
          echo "✅ 已替换 libtool 脚本中的 /usr/bin/env bash 为 /bin/bash"

      - name: Patch ninja Makefile
        run: |
          cd "${BUILD_DIR}/tools/ninja"
          sed -i 's/--no-rebuild//g' Makefile

      - name: Build tools
        run: |
          cd "${BUILD_DIR}"
          make tools/install -j$(nproc) V=s || make tools/install -j1 V=s

      - name: Build toolchain
        run: |
          cd "${BUILD_DIR}"
          make toolchain/install -j$(nproc) V=s || make toolchain/install -j1 V=s

      - name: Build target
        run: |
          cd "${BUILD_DIR}"
          make target/compile -j$(nproc) V=s || make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${BUILD_DIR}"
          make package/compile -j$(nproc) V=s || make package/compile -j1 V=s
          make package/install -j$(nproc) V=s || make package/install -j1 V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${BUILD_DIR}"
          make image PROFILE="${PROFILE}" -j$(nproc) V=s || make image PROFILE="${PROFILE}" -j1 V=s

      - name: Verify firmware output
        run: |
          cd "${BUILD_DIR}"
          ls -lh "${TARGET_DIR}" || { echo "❌ No firmware found"; exit 1; }
          md5sum "${TARGET_DIR}"/* || true
          sha256sum "${TARGET_DIR}"/* || true
          for bin in "${TARGET_DIR}"/*; do file "$bin"; done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}
