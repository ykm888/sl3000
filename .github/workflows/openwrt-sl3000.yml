name: ImmortalWrt Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  DTS_NAME: mt7981b-sl3000-emmc

  # 默认路径（自动检测会覆盖）
  DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
  DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile

  MK_FILE: target/linux/mediatek/image/filogic.mk
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: /mnt/openwrt
  CCACHE_DIR: /mnt/ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ---------------------------------------------------------
      # 0. 自动检测 + 自动修复 DTS 路径
      # ---------------------------------------------------------
      - name: Auto Detect & Fix DTS Path
        run: |
          echo "=== Auto Detecting DTS Path ==="

          CORRECT_DTS="target/linux/mediatek/files-6.12/filogic/arch/arm64/boot/dts/mediatek/${{ env.DTS_NAME }}.dts"
          CORRECT_DTS_MK="target/linux/mediatek/files-6.12/filogic/arch/arm64/boot/dts/mediatek/Makefile"

          # 修复 DTS_FILE
          if [ -f "$CORRECT_DTS" ]; then
            echo "Found correct DTS at: $CORRECT_DTS"
            echo "DTS_FILE=$CORRECT_DTS" >> $GITHUB_ENV
          else
            echo "ERROR: DTS not found at correct path!"
            echo "Expected: $CORRECT_DTS"
            exit 1
          fi

          # 修复 DTS_MK（可选）
          if [ -f "$CORRECT_DTS_MK" ]; then
            echo "Found DTS_MK at: $CORRECT_DTS_MK"
            echo "DTS_MK=$CORRECT_DTS_MK" >> $GITHUB_ENV
          else
            echo "No DTS_MK override found (this is normal)"
            echo "DTS_MK=" >> $GITHUB_ENV
          fi

          echo "=== DTS Path Auto-Fix Completed ==="

      # ---------------------------------------------------------
      # 1. Pre-build Disk Optimization
      # ---------------------------------------------------------
      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Move source to /mnt
        run: |
          sudo mkdir -p ${{ env.BUILD_DIR }}
          sudo rsync -a --delete . ${{ env.BUILD_DIR }}
          sudo chown -R $USER:$USER ${{ env.BUILD_DIR }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git \
            ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          sudo mkdir -p ${{ env.CCACHE_DIR }}
          sudo chown $USER:$USER ${{ env.CCACHE_DIR }}
          export CCACHE_DIR=${{ env.CCACHE_DIR }}
          ccache --max-size=5G
          ccache -z
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ env.PROFILE }}-${{ github.run_id }}
          restore-keys: |
            immortalwrt-${{ env.PROFILE }}-

      # ---------------------------------------------------------
      # 2. DTS 清理 + 基础语法校验
      # ---------------------------------------------------------
      - name: Clean & Validate DTS File
        run: |
          cd ${{ env.BUILD_DIR }}

          echo "Using DTS_FILE=${{ env.DTS_FILE }}"

          sed -i '1s/^\xEF\xBB\xBF//' "${{ env.DTS_FILE }}" || true
          sed -i 's/\r//g' "${{ env.DTS_FILE }}" || true
          tr -d '\000-\010\013\014\016-\037' < "${{ env.DTS_FILE }}" > "${{ env.DTS_FILE }}.clean"
          mv "${{ env.DTS_FILE }}.clean" "${{ env.DTS_FILE }}"

          echo "=== DTS Header Check (First 15 Lines) ==="
          head -15 "${{ env.DTS_FILE }}"

          echo "=== Validating DTS Syntax ==="
          if ! dtc -I dts -O dtb -o /dev/null "${{ env.DTS_FILE }}"; then
            echo "ERROR: DTS Syntax Error!"
            exit 1
          fi
          echo "DTS Syntax Check Passed"

      # ---------------------------------------------------------
      # 3. DTS 深度分析（include / label / 节点冲突 / DTB diff）
      # ---------------------------------------------------------
      - name: Deep DTS Analysis
        run: |
          cd ${{ env.BUILD_DIR }}
          mkdir -p logs/dts
          DTS="${{ env.DTS_FILE }}"
          DTB_OUT="logs/dts/${{ env.DTS_NAME }}.dtb"
          DUMP_DTS="logs/dts/${{ env.DTS_NAME }}.dump.dts"

          echo "=== Rebuild DTB for Analysis ==="
          dtc -I dts -O dtb -o "$DTB_OUT" "$DTS"

          echo "=== Dump DTB Back to DTS (Normalized) ==="
          dtc -I dtb -O dts -o "$DUMP_DTS" "$DTB_OUT"

          echo "=== DTS Include Dependency Check ==="
          grep -E '^#include' "$DTS" || echo "No #include lines found (OK if base DTS)"

          echo "=== DTS Label Duplicate Check ==="
          # 提取 label: node 形式，统计重复
          awk '/:/{print $1}' "$DTS" | sed 's/:$//' | sort | uniq -d > logs/dts/duplicate_labels.txt || true
          if [ -s logs/dts/duplicate_labels.txt ]; then
            echo "WARNING: Duplicate labels detected:"
            cat logs/dts/duplicate_labels.txt
          else
            echo "No duplicate labels detected."
          fi

          echo "=== DTS Node Path Conflict Check ==="
          # 粗略提取 node@addr 路径
          grep -E '^[[:space:]]*[a-zA-Z0-9,_-]+(@[0-9a-fA-Fx]+)?[[:space:]]*\{' "$DTS" \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*\{.*$//' \
            | sort | uniq -d > logs/dts/duplicate_nodes.txt || true
          if [ -s logs/dts/duplicate_nodes.txt ]; then
            echo "WARNING: Potential duplicate node names:"
            cat logs/dts/duplicate_nodes.txt
          else
            echo "No obvious duplicate node names."
          fi

          echo "=== DTB Structural Dump Summary ==="
          head -40 "$DUMP_DTS" || true

      # ---------------------------------------------------------
      # 4. 三件套一致性检查
      # ---------------------------------------------------------
      - name: Full 3-piece Consistency Check & Auto-fix
        run: |
          cd ${{ env.BUILD_DIR }}
          set -e

          echo "=== Checking DTS File Exists ==="
          test -f "${{ env.DTS_FILE }}" || { echo "DTS Missing"; exit 1; }

          echo "=== Checking MK File Exists ==="
          test -f "${{ env.MK_FILE }}" || { echo "MK Missing"; exit 1; }

          echo "=== Checking MK Device Definition ==="
          grep -q "define Device/${{ env.PROFILE }}" "${{ env.MK_FILE }}" || exit 1

          echo "=== Checking DEVICE_DTS ==="
          grep -q "DEVICE_DTS := ${{ env.DTS_NAME }}" "${{ env.MK_FILE }}" || exit 1

          # DTS_MK 可选
          if [ -n "${{ env.DTS_MK }}" ] && [ -f "${{ env.DTS_MK }}" ]; then
            echo "=== Checking DTS_MK dtb-y Entry ==="
            grep -q "dtb-y += ${{ env.DTS_NAME }}.dtb" "${{ env.DTS_MK }}" || \
              echo "dtb-y += ${{ env.DTS_NAME }}.dtb" >> "${{ env.DTS_MK }}"
          else
            echo "Skipping DTS_MK check (not provided)"
          fi

          echo "=== 3-piece Check Passed ==="

      # ---------------------------------------------------------
      # 5. Feeds / Tools / Toolchain / Target / Packages / Firmware
      # ---------------------------------------------------------
      - name: Setup Feeds
        run: |
          cd ${{ env.BUILD_DIR }}
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build Tools
        run: |
          cd ${{ env.BUILD_DIR }}
          make tools/install -j2 V=s

      - name: Build Toolchain
        run: |
          cd ${{ env.BUILD_DIR }}
          make toolchain/install -j1 V=s

      - name: Build Target
        run: |
          cd ${{ env.BUILD_DIR }}
          make target/compile -j1 V=s

      - name: Build Packages
        run: |
          cd ${{ env.BUILD_DIR }}
          make package/compile -j2 V=s
          make package/install -j2 V=s
          make package/index

      - name: Build Firmware
        run: |
          cd ${{ env.BUILD_DIR }}
          make -j2 V=s || make -j1 V=s

      - name: Verify Firmware Output
        run: |
          cd ${{ env.BUILD_DIR }}
          echo "=== Firmware List ==="
          ls -lh ${{ env.TARGET_DIR }}/*${{ env.PROFILE }}* || { echo "ERROR: No Firmware Found"; exit 1; }
          echo -e "\n=== MD5 Checksum ==="
          md5sum ${{ env.TARGET_DIR }}/*${{ env.PROFILE }}* || true
          echo -e "\n=== File Type Check ==="
          for bin in ${{ env.TARGET_DIR }}/*${{ env.PROFILE }}*.bin; do
            file $bin || true
          done
          echo "✅ Firmware Validation Passed"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}/**/*${{ env.PROFILE }}*
            ${{ env.BUILD_DIR }}/logs/dts/*
