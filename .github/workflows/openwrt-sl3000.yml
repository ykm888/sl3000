name: ImmortalWrt SL3000 Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  DTS_NAME: mt7981b-sl3000-emmc
  DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
  MK_FILE: target/linux/mediatek/image/filogic.mk
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: openwrt
  CCACHE_DIR: ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ---------------------------------------------------------
      # 0. 基础准备：拉代码 + 磁盘清理
      # ---------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Prepare build directory
        run: |
          mkdir -p "${{ env.BUILD_DIR }}"
          rsync -a --delete ./ "${{ env.BUILD_DIR }}/"
          df -h

      # ---------------------------------------------------------
      # 1. 构建环境：依赖 + ccache + 缓存
      # ---------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev \
            file wget curl git ccache time pkg-config libelf-dev \
            rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> "$GITHUB_ENV"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          ccache --max-size=5G
          ccache -z

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ env.PROFILE }}-${{ github.run_id }}
          restore-keys: |
            immortalwrt-${{ env.PROFILE }}-
            immortalwrt-toolchain-
            immortalwrt-base-

      # ---------------------------------------------------------
      # 2. DTS 路径 & 三件套一致性（只读检查）
      # ---------------------------------------------------------
      - name: Validate DTS & image definition (3-piece check)
        run: |
          cd "${{ env.BUILD_DIR }}"

          echo "=== [DTS Path Check] ==="
          if [ ! -f "${{ env.DTS_FILE }}" ]; then
            echo "❌ DTS not found: ${PWD}/${{ env.DTS_FILE }}"
            exit 1
          fi
          echo "✅ DTS exists: ${PWD}/${{ env.DTS_FILE }}"

          echo "=== [MK File Check] ==="
          if [ ! -f "${{ env.MK_FILE }}" ]; then
            echo "❌ MK file not found: ${PWD}/${{ env.MK_FILE }}"
            exit 1
          fi
          echo "✅ MK exists: ${PWD}/${{ env.MK_FILE }}"

          echo "=== [Device Definition Check] ==="
          if ! grep -q "define Device/${{ env.PROFILE }}" "${{ env.MK_FILE }}"; then
            echo "❌ Device/${{ env.PROFILE }} not defined in ${{
              env.MK_FILE }}"
            exit 1
          fi
          echo "✅ Device/${{ env.PROFILE }} defined"

          echo "=== [DEVICE_DTS Check] ==="
          if ! grep -q "DEVICE_DTS := ${{ env.DTS_NAME }}" "${{ env.MK_FILE }}"; then
            echo "❌ DEVICE_DTS mismatch in ${{
              env.MK_FILE }}"
            exit 1
          fi
          echo "✅ DEVICE_DTS aligned: ${{ env.DTS_NAME }}"

          echo "=== [DEVICE_DTS_DIR Check] ==="
          MK_DTS_DIR=$(grep -E "^[[:space:]]*DEVICE_DTS_DIR[[:space:]]*:=" "${{ env.MK_FILE }}" | head -1 | awk -F':=' '{print $2}' | xargs)

          if [ -z "$MK_DTS_DIR" ]; then
            echo "❌ DEVICE_DTS_DIR not found in ${{ env.MK_FILE }}"
            exit 1
          fi

          echo "MK declares DEVICE_DTS_DIR as: '$MK_DTS_DIR'"

          if [ ! -d "$MK_DTS_DIR" ] && [ ! -d "${PWD}/$MK_DTS_DIR" ]; then
            echo "⚠️ Warning: DEVICE_DTS_DIR directory not found on filesystem:"
            echo "   - $MK_DTS_DIR"
            echo "   - ${PWD}/$MK_DTS_DIR"
            echo "继续构建，但建议你确认目录是否正确。"
          else
            echo "✅ DEVICE_DTS_DIR directory looks valid."
          fi

      # ---------------------------------------------------------
      # 3. Feeds & 工具链（可复用缓存）
      # ---------------------------------------------------------
      - name: Setup feeds
        run: |
          cd "${{ env.BUILD_DIR }}"
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools
        run: |
          cd "${{ env.BUILD_DIR }}"
          make tools/install -j$(nproc) V=s

      - name: Build toolchain
        run: |
          cd "${{ env.BUILD_DIR }}"
          make toolchain/install -j$(nproc) V=s

      # ---------------------------------------------------------
      # 4. DTS 校验：此时 tools + toolchain 已就绪，kernel-dtc 可用
      # ---------------------------------------------------------
      - name: DTS validation via OpenWrt kernel-dtc
        run: |
          cd "${{ env.BUILD_DIR }}"
          mkdir -p logs/dts

          echo "=== [DTS Header Preview] ==="
          head -15 "${{ env.DTS_FILE }}" || true

          echo "=== [DTS Validation] make target/linux/compile CHECK=1 V=s ==="
          if ! make target/linux/compile CHECK=1 V=s -j1; then
            echo "❌ DTS validation failed via kernel-dtc"
            echo "=== [DTS Hexdump First 256 bytes] ==="
            hexdump -C "${{ env.DTS_FILE }}" | head -40 || true
            exit 1
          fi

          echo "✅ DTS validation passed via kernel-dtc"

      # ---------------------------------------------------------
      # 5. Target & Packages & Image
      # ---------------------------------------------------------
      - name: Build target
        run: |
          cd "${{ env.BUILD_DIR }}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${{ env.BUILD_DIR }}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${{ env.BUILD_DIR }}"
          make image PROFILE="${{ env.PROFILE }}" -j$(nproc) V=s || \
          make image PROFILE="${{ env.PROFILE }}" -j1 V=s

      # ---------------------------------------------------------
      # 6. 固件验证 + 产物上传
      # ---------------------------------------------------------
      - name: Verify firmware output
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== [Firmware List] ==="
          if [ ! -d "${{ env.TARGET_DIR }}/${{ env.PROFILE }}" ]; then
            echo "❌ No firmware directory: ${{
              env.TARGET_DIR }}/${{ env.PROFILE }}"
            ls -R "${{ env.TARGET_DIR }}" || true
            exit 1
          fi

          ls -lh "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"

          echo "=== [MD5 Checksum] ==="
          md5sum "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"/* || true

          echo "=== [File Type Check] ==="
          for bin in "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"/*; do
            file "$bin" || true
          done

          echo "✅ Firmware validation passed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}/${{ env.PROFILE }}
            ${{ env.BUILD_DIR }}/logs/dts
