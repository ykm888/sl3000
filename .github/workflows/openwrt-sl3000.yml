name: Build SL3000 Firmware

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  full-build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Prepare /mnt workspace
      run: |
        # 清理磁盘空间，释放 10GB+
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker system prune -af || true
        df -h /

        # 创建工作目录
        sudo mkdir -p /mnt/openwrt /mnt/ccache /mnt/dl /mnt/staging /mnt/host
        sudo chown $USER:$USER /mnt/openwrt /mnt/ccache /mnt/dl /mnt/staging /mnt/host
        rsync -a . /mnt/openwrt/
        echo "WORKDIR=/mnt/openwrt" >> $GITHUB_ENV
        echo "CCACHE_DIR=/mnt/ccache" >> $GITHUB_ENV
        echo "DL_DIR=/mnt/dl" >> $GITHUB_ENV
        echo "STAGING_DIR=/mnt/staging" >> $GITHUB_ENV
        echo "HOST_DIR=/mnt/host" >> $GITHUB_ENV
        echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV
        df -h / /mnt

    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: /mnt/ccache
        key: ${{ runner.os }}-ccache-${{ github.ref }}
        restore-keys: |
          ${{ runner.os }}-ccache

    - name: Cache dl sources
      uses: actions/cache@v3
      with:
        path: /mnt/dl
        key: ${{ runner.os }}-dl-${{ github.ref }}
        restore-keys: |
          ${{ runner.os }}-dl

    - name: Cache toolchain
      uses: actions/cache@v3
      with:
        path: /mnt/staging/toolchain-*
        key: ${{ runner.os }}-toolchain-${{ github.ref }}
        restore-keys: |
          ${{ runner.os }}-toolchain

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev rsync unzip zlib1g-dev file wget curl \
          python3 python3-pip python3-setuptools ccache perl pkg-config libelf-dev \
          libncursesw5-dev parted e2fsprogs m4 autoconf automake libgmp-dev libmpfr-dev \
          libmpc-dev gperf texinfo zstd jq

    - name: Update feeds
      run: |
        cd "$WORKDIR"
        ./scripts/feeds update -a || (sleep 3 && ./scripts/feeds update -a)
        ./scripts/feeds install -a || (sleep 3 && ./scripts/feeds install -a)

    - name: Force SL3000 profile
      run: |
        cd "$WORKDIR"
        rm -f .config
        cat >> .config <<'EOF'
        CONFIG_TARGET_mediatek=y
        CONFIG_TARGET_mediatek_filogic=y
        CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y
        CONFIG_TARGET_ROOTFS_SQUASHFS=y
        # 禁用多 profile
        # CONFIG_TARGET_MULTI_PROFILE is not set
        EOF
        make defconfig
        yes "" | make oldconfig

    - name: Verify 三件套
      run: |
        cd "$WORKDIR"
        grep "sl3000-emmc" .config || { echo ".config 缺少 sl3000-emmc"; exit 1; }
        grep "sl3000-emmc" target/linux/mediatek/image/filogic.mk || { echo "filogic.mk 缺少 sl3000-emmc"; exit 1; }
        ls target/linux/mediatek/files-*/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts || { echo "DTS 缺失"; exit 1; }

    - name: Build firmware
      run: |
        cd "$WORKDIR"
        make download -j2 || make download -j1
        make tools/install -j1 V=s | tee /mnt/openwrt/build_tools.log
        make toolchain/install -j1 V=s | tee /mnt/openwrt/build_toolchain.log
        rm -rf bin tmp build_dir/target-*/root-*/.*tmp || true
        make -j2 V=s | tee /mnt/openwrt/build_world.log || make -j1 V=s | tee /mnt/openwrt/build_world.log
        ccache -s || true

    - name: Dump diffconfig
      run: |
        cd "$WORKDIR"
        ./scripts/diffconfig.sh | tee /mnt/openwrt/diffconfig.log
        grep "sl3000-emmc" /mnt/openwrt/diffconfig.log || { echo "最终配置未启用 sl3000-emmc"; exit 1; }

    - name: Check output
      run: |
        TARGET_DIR="$WORKDIR/bin/targets/mediatek/filogic"
        cd "$TARGET_DIR"
        ls -lh
        FW=$(ls *sl3000-emmc*sysupgrade*.bin 2>/dev/null || true)
        if [ -n "$FW" ]; then
          SIZE=$(stat -c%s "$FW")
          [ "$SIZE" -gt 4000000 ] || { echo "固件过小 ($SIZE bytes)"; exit 1; }
          echo "找到固件: $FW ($SIZE bytes)"
          sha256sum $FW | tee "$WORKDIR/bin/targets/mediatek/filogic/sha256sums.txt"
        else
          echo "未生成 SL3000 固件"
          exit 1
        fi

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-firmware
        path: |
          ${{ env.WORKDIR }}/bin/targets/mediatek/filogic/*sl3000-emmc*sysupgrade*.bin
          ${{ env.WORKDIR }}/bin/targets/mediatek/filogic/sha256sums.txt
        retention-days: 30

    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          /mnt/openwrt/build_tools.log
          /mnt/openwrt/build_toolchain.log
          /mnt/openwrt/build_world.log
          /mnt/openwrt/diffconfig.log
        retention-days: 30
