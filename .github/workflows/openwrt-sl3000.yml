name: Build ImmortalWrt SL3000

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      PROFILE: sl3000-emmc
      DTS_NAME: mt7981b-sl3000-emmc
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk gettext libncurses5-dev libssl-dev python3 rsync unzip zlib1g-dev

      - name: Update feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: DTS/mk sanity check
        run: |
          DTS_FILE="target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/${DTS_NAME}.dts"
          MK_FILE="target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile"
          IMAGE_MK="target/linux/mediatek/image/filogic.mk"
          [ -f "${DTS_FILE}" ] || { echo "❌ DTS 文件不存在: ${DTS_FILE}"; exit 1; }
          [ -f "${MK_FILE}" ] || { echo "❌ DTS Makefile 不存在: ${MK_FILE}"; exit 1; }
          [ -f "${IMAGE_MK}" ] || { echo "❌ filogic.mk 不存在: ${IMAGE_MK}"; exit 1; }
          grep -q "${DTS_NAME}.dtb" "${MK_FILE}" || { echo "❌ DTS Makefile 未包含 ${DTS_NAME}.dtb"; exit 1; }
          echo "✅ DTS/mk 检查通过"

      - name: Configure target
        run: |
          echo "CONFIG_TARGET_mediatek_filogic=y" > .config
          echo "CONFIG_TARGET_mediatek_filogic_${PROFILE}=y" >> .config
          make defconfig

      - name: Build firmware
        run: |
          make -j$(nproc) || make -j1 V=s || make -j1 V=s IGNORE_ERRORS=m

      - name: Verify firmware artifacts
        run: |
          [ -d "${TARGET_DIR}" ] || { echo "❌ 未找到 TARGET_DIR: ${TARGET_DIR}"; exit 1; }
          ls -lh "${TARGET_DIR}"
          compgen -G "${TARGET_DIR}/*sysupgrade.bin" > /dev/null || { echo "❌ 缺少 sysupgrade.bin"; exit 1; }
          compgen -G "${TARGET_DIR}/*initramfs-kernel.bin" > /dev/null || { echo "❌ 缺少 initramfs-kernel.bin"; exit 1; }
          # initramfs-recovery 可选，不报错
          compgen -G "${TARGET_DIR}/*initramfs-recovery.bin" > /dev/null && echo "ℹ️ initramfs-recovery 存在"
          echo "✅ 固件产物检查通过"

      - name: Package artifacts
        run: |
          tar -czf immortalwrt-${PROFILE}-firmware.tar.gz -C "${TARGET_DIR}" .
          sha256sum immortalwrt-${PROFILE}-firmware.tar.gz > sha256sums

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${PROFILE}-firmware
          path: |
            immortalwrt-${PROFILE}-firmware.tar.gz
            sha256sums

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/master'
        with:
          files: |
            immortalwrt-${PROFILE}-firmware.tar.gz
            sha256sums