name: ImmortalWrt SL3000 Flagship Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      BUILD_DIR: openwrt
      PROFILE: sl3000-emmc
      TARGET_DIR: openwrt/bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git $BUILD_DIR
          cd $BUILD_DIR
          git checkout openwrt-24.10

      - name: Optimize disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Cache downloads and build_dir
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/build_dir
          key: ${{ runner.os }}-immortalwrt-${{ github.run_id }}

      - name: Detect patch directory
        run: |
          if [ -d "${BUILD_DIR}/target/linux/mediatek/patches-6.12" ]; then
            echo "PATCH_DIR=${BUILD_DIR}/target/linux/mediatek/patches-6.12" >> $GITHUB_ENV
          elif [ -d "${BUILD_DIR}/target/linux/mediatek/patches-6.6" ]; then
            echo "PATCH_DIR=${BUILD_DIR}/target/linux/mediatek/patches-6.6" >> $GITHUB_ENV
          else
            echo "❌ No patches directory found"
            exit 1
          fi

      - name: Apply router-specific patches
        run: |
          cd $PATCH_DIR
          for p in $(ls *.patch | grep -E "dts|mt7981|router|net"); do
            patch -p1 < $p
          done

      - name: Auto-fix three-piece files
        run: |
          cd "${BUILD_DIR}"
          [ -f .config ] || touch .config
          [ -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts ] || echo "/dts-v1/;" > target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts
          [ -f target/linux/mediatek/image/filogic.mk ] || echo "# filogic mk" > target/linux/mediatek/image/filogic.mk

      - name: Setup feeds
        run: |
          cd "${BUILD_DIR}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools
        run: |
          cd "${BUILD_DIR}"
          make tools/install -j$(nproc) V=s

      - name: Build toolchain
        run: |
          cd "${BUILD_DIR}"
          make toolchain/install -j$(nproc) V=s

      - name: Build target
        run: |
          cd "${BUILD_DIR}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${BUILD_DIR}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${BUILD_DIR}"
          make image PROFILE="${PROFILE}" -j$(nproc) V=s || \
          make image PROFILE="${PROFILE}" -j1 V=s

      - name: Verify firmware output
        run: |
          cd "${BUILD_DIR}"
          ls -lh "${TARGET_DIR}" || { echo "❌ No firmware found"; exit 1; }
          md5sum "${TARGET_DIR}"/* || true
          sha256sum "${TARGET_DIR}"/* || true
          for bin in "${TARGET_DIR}"/*; do file "$bin"; done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-flagship-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}
            ${{ env.BUILD_DIR }}/logs
