name: ImmortalWrt Build
on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  TARGET_DIR: bin/targets/mediatek/filogic

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. 官方源码
      - name: Checkout official ImmortalWrt
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: master
          fetch-depth: 0

      # 2. 你的仓库（三件套 + fragment.config）
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          path: myrepo

      # 3. 三件套检测（延续上一版）
      - name: Validate 3-piece set
        run: |
          test -f myrepo/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
          test -f myrepo/target/linux/mediatek/image/filogic.mk
          test -f myrepo/fragment.config
          echo "3-piece set OK"

      # 4. 构建依赖 + ccache（延续上一版）
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git coreutils \
            ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler
          echo 'export PATH="/usr/lib/ccache:$PATH"' >> $GITHUB_ENV

      # 5. 清理构建缓存（延续上一版）
      - name: Clean build cache
        run: |
          rm -rf build_dir staging_dir tmp
          rm -rf dl/*.tmp || true
          find . -name "*.rej" -delete
          find . -name "*.orig" -delete
          make clean
          make dirclean

      # 6. 深度优化磁盘空间（延续上一版）
      - name: Optimize disk space
        run: |
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo docker system prune -af || true
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo rm -rf ~/.cache/pip ~/.npm ~/.nvm
          sudo rm -rf /var/log/* /usr/share/man/* /usr/share/doc/* /usr/share/locales/*
          sudo apt-get autoremove -y
          sudo rm -rf /tmp/* /var/tmp/*

      # 7. sbwml feeds（延续方案 A）
      - name: Patch feeds.conf.default for sbwml
        run: |
          sed -i 's|src-git luci .*|src-git luci https://github.com/sbwml/luci.git;master|' feeds.conf.default
          sed -i 's|src-git packages .*|src-git packages https://github.com/sbwml/packages.git;master|' feeds.conf.default
          echo "src-git passwall2 https://github.com/sbwml/luci-app-passwall2.git;main" >> feeds.conf.default

      # 8. Feeds（延续上一版）
      - name: Feeds update/install
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 9. 自动生成完整 .config（新增功能）
      - name: Generate full config
        run: |
          # 写入基础 target
          echo "CONFIG_TARGET_mediatek=y" > .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" >> .config

          # 叠加你原来的配置片段
          cat myrepo/fragment.config >> .config

          # 自动补齐依赖，生成完整可构建的 .config
          make defconfig

      # 10. 覆盖三件套（延续上一版）
      - name: Apply DTS/mk
        run: |
          cp myrepo/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/*.dts \
             target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/

          cp myrepo/target/linux/mediatek/image/filogic.mk \
             target/linux/mediatek/image/

      # 11. 构建固件（延续上一版）
      - name: Build firmware
        run: |
          make -j"$(nproc)" || make -j1 V=s

      # 12. 上传完整 .config（新增）
      - name: Upload full config
        uses: actions/upload-artifact@v4
        with:
          name: full-config
          path: .config

      # 13. 上传固件（延续上一版）
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}
          path: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/*.manifest
            ${{ env.TARGET_DIR }}/*.buildinfo
            ${{ env.TARGET_DIR }}/profiles.json