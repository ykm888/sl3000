name: Build SL3000-EMMC Firmware

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      TARGET_DIR: /mnt/openwrt/bin/targets/mediatek/filogic
      DTS_PATH: /mnt/openwrt/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      MK_PATH: /mnt/openwrt/target/linux/mediatek/image/filogic.mk
      PROFILE: sl3000-emmc

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Move source to /mnt (66G space)
        run: |
          mkdir -p /mnt/openwrt
          rsync -a ./ /mnt/openwrt/
          cd /mnt/openwrt

      # 磁盘空间优化
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          sudo rm -rf /var/lib/apt/lists/* || true

      # 缓存 dl/ 和 build_dir
      - name: Cache dl and build_dir
        uses: actions/cache@v4
        with:
          path: |
            /mnt/openwrt/dl
            /mnt/openwrt/build_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','package/**/*','target/**/*','toolchain/**/*','tools/**/*','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      # 安装依赖
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip wget git zlib1g-dev file

      # 三件套检测
      - name: Verify three-piece set
        run: |
          cd /mnt/openwrt
          test -f .config || (echo "❌ .config missing" && exit 1)
          test -f "${DTS_PATH}" || (echo "❌ DTS missing at ${DTS_PATH}" && exit 1)
          grep -q "${PROFILE}" "${MK_PATH}" || (echo "❌ mk missing profile ${PROFILE}" && exit 1)

      # 自动注册 profile
      - name: Ensure profile registered in mk
        run: |
          cd /mnt/openwrt
          if ! grep -q "TARGET_DEVICES += ${PROFILE}" "${MK_PATH}"; then
            echo "⚠️ TARGET_DEVICES += ${PROFILE} not found, auto-append"
            echo "TARGET_DEVICES += ${PROFILE}" >> "${MK_PATH}"
          fi

      # 准备配置
      - name: Prepare .config
        run: |
          cd /mnt/openwrt
          cp .config .config.backup
          sed -i '/CONFIG_TARGET_mediatek_filogic_DEVICE_/d' .config
          {
            echo "CONFIG_TARGET_mediatek=y"
            echo "CONFIG_TARGET_mediatek_filogic=y"
            echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y"
          } >> .config
          grep -v 'CONFIG_TARGET_mediatek_filogic_DEVICE_' .config.backup >> .config
          make defconfig
          echo "=== Effective device selections ==="
          grep CONFIG_TARGET_mediatek_filogic_DEVICE .config || true

      # 构建 + 自动修复
      - name: Build firmware with auto-repair
        run: |
          cd /mnt/openwrt
          make -j$(nproc) V=s || (
            echo "⚠️ 初次构建失败，清理 build_dir 重试一次"
            rm -rf build_dir
            make -j$(nproc) V=s || (
              echo "⚠️ 二次构建失败，清理 dl+tmp 再试"
              rm -rf dl build_dir tmp
              make -j$(nproc) V=s
            )
          )

      # 上传固件（Artifacts）
      - name: Upload firmware artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${PROFILE}-firmware
          path: ${{ env.TARGET_DIR }}/*

      # 自动发布 Release
      - name: Publish GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARGET_DIR }}/*
          tag_name: ${PROFILE}-${{ github.run_number }}
          name: ${PROFILE} Firmware Build ${{ github.run_number }}
          draft: false
          prerelease: false

      # 上传日志
      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: /mnt/openwrt/logs/
          if-no-files-found: warn