name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-20.04   # ⭐ 关键修复：使用 20.04，避免 m4 崩溃

    env:
      BUILD_DIR: ${{ github.workspace }}
      PROFILE: sl3000-emmc
      DTS_PATH: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      MK_PATH: target/linux/mediatek/image/filogic.mk
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: Cache dl, build_dir, staging_dir
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/build_dir
            ${{ env.BUILD_DIR }}/staging_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','**/*.mk','**/*.dts','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip wget git zlib1g-dev file m4

      - name: Force rebuild host toolchain   # ⭐ 关键修复：重建 host 工具链
        run: |
          rm -rf staging_dir/host
          rm -rf build_dir/host

      - name: Feeds auto repair
        run: |
          ./scripts/feeds update -a || { echo "❌ feeds update failed"; exit 1; }
          ./scripts/feeds install -a || { echo "❌ feeds install failed"; exit 1; }

      - name: Patch auto check
        run: |
          PATCH_DIRS=$(ls -d target/linux/mediatek/patches-* 2>/dev/null || true)
          if [ -z "$PATCH_DIRS" ]; then
            echo "ℹ️ 无补丁目录，跳过 patch 检查"
            exit 0
          fi
          echo "ℹ️ 检查补丁是否能干净应用..."
          find $PATCH_DIRS -name '*.patch' \
            -exec sh -c 'patch -p1 --dry-run -f < "$1"' _ {} \; || {
              echo "❌ 补丁未能完全贴合"
              exit 1
            }

      - name: DTS auto repair
        run: |
          if [ ! -f "${DTS_PATH}" ]; then
            echo "⚠️ DTS missing, restoring"
            cp dts/mt7981b-sl3000-emmc.dts "${DTS_PATH}" || exit 1
          fi

      - name: mk auto repair
        run: |
          grep -q "${PROFILE}" "${MK_PATH}" || {
            echo "" >> "${MK_PATH}"
            echo "TARGET_DEVICES += ${PROFILE}" >> "${MK_PATH}"
          }

      - name: mk integrity check
        run: |
          grep -q "define Device/${PROFILE}" "${MK_PATH}" || {
            echo "❌ mk 缺少 define Device/${PROFILE}"
            exit 1
          }

      - name: .config auto repair
        run: |
          if [ -f .config ]; then cp .config .config.bak; fi
          sed -i '/^CONFIG_TARGET_/d' .config 2>/dev/null || true
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y" >> .config

          # 禁用所有非路由器驱动
          echo "# CONFIG_SOUND is not set" >> .config
          echo "# CONFIG_SND is not set" >> .config
          echo "# CONFIG_DRM is not set" >> .config
          echo "# CONFIG_MEDIA_SUPPORT is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-video-core is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-printer is not set" >> .config
          echo "# CONFIG_PACKAGE_p910nd is not set" >> .config
          echo "# CONFIG_BT is not set" >> .config
          echo "# CONFIG_USB_SUPPORT is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-core is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb2 is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb3 is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-ohci is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-uhci is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-storage is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-net is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-usb-audio is not set" >> .config
          echo "# CONFIG_X86 is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-i2c-i801 is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-e1000 is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-e1000e is not set" >> .config
          echo "# CONFIG_PACKAGE_kmod-ixgbe is not set" >> .config

          make defconfig

      - name: DTS compile check
        run: |
          make target/linux/compile -j"$(nproc)" V=s
          find build_dir/target-*/linux-*/arch/arm64/boot/dts/mediatek/ \
            -name '*sl3000-emmc.dtb' | grep -q . || {
              echo "❌ DTS 未被编译为 dtb"
              exit 1
            }

      - name: Build firmware with auto-repair
        run: |
          set -e
          build_once() { make -j"$(nproc)" V=s; }
          if ! build_once; then
            echo "⚠️ 构建失败，清理 build_dir 重试"
            rm -rf build_dir
            if ! build_once; then
              echo "⚠️ 再次失败，清理 dl + build_dir + staging_dir + tmp 再试"
              rm -rf dl build_dir staging_dir tmp
              build_once
            fi
          fi

      - name: Verify firmware output
        run: |
          ls -lh "${TARGET_DIR}" || { echo "❌ 固件目录不存在"; exit 1; }
          test -s ${TARGET_DIR}/*.bin || { echo "❌ 固件未生成或为空"; exit 1; }

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: ${{ env.TARGET_DIR }}/*

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARGET_DIR }}/*
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: SL3000-EMMC Build ${{ github.run_number }}
          body: |
            - Profile: sl3000-emmc
            - DTS: ${{ env.DTS_PATH }}
            - mk:  ${{ env.MK_PATH }}
            - Commit: ${{ github.sha }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            logs/
            build_dir/
            staging_dir/