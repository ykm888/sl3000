name: Build SL3000-EMMC Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk libncurses5-dev libncursesw5-dev \
            zlib1g-dev libssl-dev wget git python3 unzip rsync file

      - name: Prepare OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Copy custom DTS and mk
        run: |
          cp target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts openwrt/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/
          cp target/linux/mediatek/image/filogic.mk openwrt/target/linux/mediatek/image/

      - name: Load config
        run: |
          cp .config openwrt/.config

      - name: Verify three-piece registration
        working-directory: openwrt
        run: |
          echo "=== DTS Check ==="
          test -f target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts && echo "✅ DTS OK" || (echo "❌ DTS MISSING!"; exit 1)
          echo "=== filogic.mk Check ==="
          grep -q 'Device/sl3000-emmc' target/linux/mediatek/image/filogic.mk && echo "✅ filogic.mk OK" || (echo "❌ MK ENTRY MISSING!"; exit 1)
          echo "=== .config Check ==="
          grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config && echo "✅ .config OK" || (echo "❌ CONFIG MISSING!"; exit 1)

      - name: Build host tools
        working-directory: openwrt
        run: make tools/install -j$(nproc) V=s

      - name: Build cross toolchain
        working-directory: openwrt
        run: make toolchain/install -j$(nproc) V=s

      - name: Sanity check toolchain
        working-directory: openwrt
        run: |
          TOOLDIR=$(echo staging_dir/toolchain-*/bin)
          test -d "$TOOLDIR" || (echo "❌ Toolchain bin missing"; exit 1)
          for tool in aarch64-openwrt-linux-musl-gcc make-ext4fs mkimage mksquashfs; do
            find staging_dir -name "*$tool*" | grep -q . || (echo "❌ Tool $tool missing"; exit 1)
          done

      - name: Optional profiles.json check
        working-directory: openwrt
        run: |
          make target/linux/compile -j1 V=s || echo "⚠️ target/linux 编译失败，跳过 profiles.json 检查"
          make package/base-files/compile -j1 V=s || echo "⚠️ base-files 编译失败，跳过 profiles.json 检查"
          if [ -f tmp/.profiles.json ]; then
            echo "✅ profiles.json 已生成"
            grep sl3000 tmp/.profiles.json || echo "⚠️ profiles.json 中未找到 sl3000-emmc"
          else
            echo "⚠️ profiles.json 缺失（不影响固件编译）"
          fi
          test -d tmp/.targetinfo && echo "✅ .targetinfo 存在" || echo "⚠️ .targetinfo 缺失"

      - name: Build firmware
        working-directory: openwrt
        run: |
          set -eo pipefail
          make -j$(nproc) || { echo "⚠️ 并行构建失败，尝试单线程重试..."; make -j1 V=s; }

      - name: Check firmware output
        working-directory: openwrt
        run: |
          ls bin/targets/**/sl3000-emmc/*.bin || (echo "❌ 固件未生成"; exit 1)

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            openwrt/bin/targets/**/sl3000-emmc/*.bin
            openwrt/bin/targets/**/sl3000-emmc/*.manifest
            openwrt/bin/targets/**/sl3000-emmc/*.buildinfo
            openwrt/bin/targets/**/sl3000-emmc/*.json

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: sl3000-emmc-${{ github.run_number }}
          release_name: SL3000-EMMC Firmware ${{ github.run_number }}
          draft: false
          prerelease: false

      - name: Upload firmware to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: openwrt/bin/targets/**/sl3000-emmc/openwrt-*.bin
          asset_name: openwrt-sl3000-emmc.bin
          asset_content_type: application/octet-stream

      - name: Generate SHA256 checksum
        working-directory: openwrt/bin/targets
        run: |
          find . -name "openwrt-*.bin" -exec sha256sum {} \; > SHA256SUMS
        continue-on-error: false

      - name: Upload checksum to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: openwrt/bin/targets/**/sl3000-emmc/SHA256SUMS
          asset_name: SHA256SUMS
          asset_content_type: text/plain