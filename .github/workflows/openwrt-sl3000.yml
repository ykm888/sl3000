name: Build SL3000-EMMC Firmware

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 python3-distutils rsync unzip wget

      - name: Sync source to /mnt/openwrt
        run: |
          mkdir -p /mnt/openwrt
          rsync -a ./ /mnt/openwrt/

      - name: Prepare .config
        run: |
          cd /mnt/openwrt
          # 清理所有 filogic 设备配置
          sed -i '/CONFIG_TARGET_mediatek_filogic_DEVICE_/d' .config
          # 强制只启用 SL3000-EMMC
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" >> .config
          make defconfig

      - name: Verify config
        run: |
          cd /mnt/openwrt
          echo "=== 当前启用的设备 ==="
          grep CONFIG_TARGET_mediatek_filogic_DEVICE .config
          echo "====================="
          if ! grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y" .config; then
            echo "❌ SL3000-EMMC 未启用，构建中止"
            exit 1
          fi

      - name: Build firmware
        run: |
          cd /mnt/openwrt
          make -j$(nproc) V=s

      - name: Upload build logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            /mnt/openwrt/build_dir/**/log.txt
            /mnt/openwrt/build_dir/**/error.txt
            /mnt/openwrt/tmp/**/*
          if-no-files-found: warn

      - name: Upload firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: /mnt/openwrt/bin/targets/mediatek/filogic/*