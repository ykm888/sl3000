name: ImmortalWrt SL3000 Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: openwrt
  CCACHE_DIR: ccache
  PROFILE: sl3000-emmc
  DTSFILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
  MKFILE: target/linux/mediatek/image/filogic.mk
  PATCHFILE: target/linux/mediatek/patches-6.12/117-complete-mt7981b-dtsi.patch

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ---------------------------------------------------------
      # 0. 基础准备：拉代码 + 磁盘清理
      # ---------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Prepare build directory
        run: |
          mkdir -p "${{ env.BUILD_DIR }}"
          rsync -a --delete ./ "${{ env.BUILD_DIR }}/"
          df -h

      # ---------------------------------------------------------
      # 1. 构建环境：依赖 + ccache + 缓存
      # ---------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev \
            file wget curl git ccache time pkg-config libelf-dev \
            rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          echo "CCACHEDIR=${{ env.CCACHE_DIR }}" >> "$GITHUB_ENV"
          export CCACHEDIR="${{ env.CCACHE_DIR }}"
          ccache --max-size=5G
          ccache -z

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ github.run_id }}
          restore-keys: |
            immortalwrt-toolchain-
            immortalwrt-base-

      # ---------------------------------------------------------
      # 2. 清理补丁，只保留 117
      # ---------------------------------------------------------
      - name: Clean patches, keep only 117
        run: |
          cd "${{ env.BUILD_DIR }}/target/linux/mediatek/patches-6.12"
          ls | grep -v "117-complete-mt7981b-dtsi.patch" | xargs -r rm -f
          echo "Remaining patches:"
          ls

      # ---------------------------------------------------------
      # 3. 三件套确认（写死路径，避免检测错误）
      # ---------------------------------------------------------
      - name: Confirm 3-piece files
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "PROFILE=${{ env.PROFILE }}"
          echo "DTSFILE=${{ env.DTSFILE }}"
          echo "MKFILE=${{ env.MKFILE }}"
          echo "PATCHFILE=${{ env.PATCHFILE }}"
          ls -lh "${{ env.DTSFILE }}" || { echo "❌ DTS file not found"; exit 1; }
          ls -lh "${{ env.MKFILE }}" || { echo "❌ MK file not found"; exit 1; }
          ls -lh "${{ env.PATCHFILE }}" || { echo "❌ Patch file not found"; exit 1; }

      # ---------------------------------------------------------
      # 4. Feeds & 工具链（强制清理缓存）
      # ---------------------------------------------------------
      - name: Setup feeds
        run: |
          cd "${{ env.BUILD_DIR }}"
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clean toolchain before build
        run: |
          cd "${{ env.BUILD_DIR }}"
          rm -rf build_dir/toolchain-* staging_dir/toolchain-*

      - name: Build tools
        run: |
          cd "${{ env.BUILD_DIR }}"
          make tools/install -j$(nproc) V=s

      - name: Build toolchain
        run: |
          cd "${{ env.BUILD_DIR }}"
          make toolchain/install -j$(nproc) V=s

      # ---------------------------------------------------------
      # 5. DTS 校验
      # ---------------------------------------------------------
      - name: DTS validation via dtc
        run: |
          cd "${{ env.BUILD_DIR }}"
          mkdir -p logs/dts
          echo "=== [DTS Header Preview] ==="
          head -15 "${{ env.DTSFILE }}" || true
          echo "=== [DTS Validation] ==="
          dtc -I dts -O dtb -o logs/dts/test.dtb "${{ env.DTSFILE }}" || \
          make target/linux/compile CHECK=1 V=s -j1
          echo "✅ DTS validation passed"

      # ---------------------------------------------------------
      # 6. Target & Packages & Image
      # ---------------------------------------------------------
      - name: Build target
        run: |
          cd "${{ env.BUILD_DIR }}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${{ env.BUILD_DIR }}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${{ env.BUILD_DIR }}"
          make image PROFILE="${{ env.PROFILE }}" -j$(nproc) V=s || \
          make image PROFILE="${{ env.PROFILE }}" -j1 V=s

      # ---------------------------------------------------------
      # 7. 固件验证 + 自动注册产物
      # ---------------------------------------------------------
      - name: Verify firmware output
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== [Firmware List] ==="
          ls -lh "${{ env.TARGET_DIR }}" || { echo "❌ No firmware found"; exit 1; }
          echo "=== [MD5 Checksum] ==="
          md5sum "${{ env.TARGET_DIR }}"/* || true
          echo "=== [SHA256 Checksum] ==="
          sha256sum "${{ env.TARGET_DIR }}"/* || true
          echo "=== [File Type Check] ==="
          for bin in "${{ env.TARGET_DIR }}"/*; do
            file "$bin" || true
          done
          echo "✅ Firmware validation passed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}
            ${{ env.BUILD_DIR }}/logs/dts
