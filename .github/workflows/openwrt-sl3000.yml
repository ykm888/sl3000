name: ImmortalWrt Engineering Build
 
on:
workflow_dispatch:
 
permissions:
contents: write
 
env:
PROFILE: sl3000-emmc
DTS_NAME: mt7981b-sl3000-emmc
DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile
MK_FILE: target/linux/mediatek/image/filogic.mk
TARGET_DIR: bin/targets/mediatek/filogic
BUILD_DIR: /mnt/openwrt
CCACHE_DIR: /mnt/ccache
 
jobs:
build:
runs-on: ubuntu-22.04
 
steps:
# ---------------------------------------------------------
# 0. Checkout
# ---------------------------------------------------------
- name: Checkout source
uses: actions/checkout@v4
with:
fetch-depth: 1
 
---------------------------------------------------------
 
1. Pre-build Disk Optimization
 
---------------------------------------------------------
 
- name: Pre-build Disk Optimization
run: |
sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
sudo apt-get clean || true
sudo docker system prune -af || true
df -h
---------------------------------------------------------
 
2. Move source to /mnt
 
---------------------------------------------------------
 
- name: Move source to /mnt
run: |
sudo mkdir -p ${{ env.BUILD_DIR }}
sudo rsync -a --delete . ${{ env.BUILD_DIR }}
sudo chown -R USER:USER ${{ env.BUILD_DIR }}
 
---------------------------------------------------------
 
3. Install Dependencies
 
---------------------------------------------------------
 
- name: Install dependencies
run: |
sudo apt-get update
sudo apt-get install -y build-essential flex bison gawk gettext 
libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git 
ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler
 
---------------------------------------------------------
 
4. Setup CCache
 
---------------------------------------------------------
 
- name: Setup ccache
run: |
sudo mkdir -p ${{ env.CCACHE_DIR }}
sudo chown USER:USER {{ env.CCACHE_DIR }}
export CCACHE_DIR={{ env.CCACHE_DIR }}
ccache --max-size=5G
ccache -z
echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> $GITHUB_ENV
 
---------------------------------------------------------
 
5. Restore Caches
 
---------------------------------------------------------
 
- name: Restore caches
uses: actions/cache@v4
with:
path: |
${{ env.CCACHE_DIR }}
${{ env.BUILD_DIR }}/dl
${{ env.BUILD_DIR }}/staging_dir/toolchain-*
{{ env.BUILD_DIR }}/build_dir/toolchain-*
key: immortalwrt-{{ env.PROFILE }}-{{ github.run_id }}
restore-keys: |
immortalwrt-{{ env.PROFILE }}-
 
---------------------------------------------------------
 
6. Clean DTS file (避免格式错误)
 
---------------------------------------------------------
 
- name: Clean DTS file
run: |
cd ${{ env.BUILD_DIR }}
去除 BOM 头、Windows 换行符、不可见字符
 
sed -i '1s/^\xEF\xBB\xBF//' "{{ env.DTS_FILE }}" || true
sed -i 's/\r//' "{{ env.DTS_FILE }}" || true
tr -d '\000-\010\013\014\016-\037' < "{{ env.DTS_FILE }}" > "{{ env.DTS_FILE }}.clean"
mv "{{ env.DTS_FILE }}.clean" "${{ env.DTS_FILE }}"
验证 DTS 语法（提前暴露问题）
 
dtc -I dts -O dtb -o /dev/null "${{ env.DTS_FILE }}" || exit 1
 
---------------------------------------------------------
 
7. Validate 3-piece consistency (DTS / MK / .config)
 
---------------------------------------------------------
 
- name: Validate & Auto-fix 3-piece consistency
run: |
cd ${{ env.BUILD_DIR }}
1. DTS_MK: 确保 DTB 被编译
 
grep -q "dtb-y += {{ env.DTS_NAME }}.dtb" "{{ env.DTS_MK }}" || 
echo "dtb-y += {{ env.DTS_NAME }}.dtb" >> "{{ env.DTS_MK }}"
2. .config: 确保设备被选中（不覆盖自定义 MK 配置）
 
if ! grep -q "CONFIG_TARGET_mediatek_filogic_DEVICE_{{ env.PROFILE }}=y" .config; then
echo "CONFIG_TARGET_mediatek_filogic_DEVICE_{{ env.PROFILE }}=y" >> .config
fi
生成默认配置（合并自定义 .config）
 
make defconfig
 
---------------------------------------------------------
 
8. Patch 处理 (跳过失败补丁，不删除)
 
---------------------------------------------------------
 
- name: Validate & Handle patches
run: |
cd ${{ env.BUILD_DIR }}
mkdir -p logs/failed_patches
处理 MT7981 内核补丁
 
for p in target/linux/mediatek/patches-6.12/*.patch; do
[ -f "$p" ] || continue
echo "Processing patch: p"
if patch --dry-run -p1 < "p" > /dev/null 2>&1; then
patch -p1 < "$p"
echo "Patch p applied successfully"
else
cp "p" logs/failed_patches/
echo "WARNING: Patch $p failed, skipped (saved to logs/failed_patches)"
fi
done
 
---------------------------------------------------------
 
9. Feeds 配置 (更新并安装所有包)
 
---------------------------------------------------------
 
- name: Setup feeds
run: |
cd ${{ env.BUILD_DIR }}
rm -rf feeds
./scripts/feeds update -a
./scripts/feeds install -a
 
---------------------------------------------------------
 
10. Build Tools (限制并发，避免内存溢出)
 
---------------------------------------------------------
 
- name: Build tools
run: |
cd ${{ env.BUILD_DIR }}
make tools/install -j2 V=s  # 2 线程平衡速度与稳定性
 
---------------------------------------------------------
 
11. Build Toolchain (单线程更稳定)
 
---------------------------------------------------------
 
- name: Build toolchain
run: |
cd ${{ env.BUILD_DIR }}
make toolchain/install -j1 V=s
 
---------------------------------------------------------
 
12. Build Target (核心编译)
 
---------------------------------------------------------
 
- name: Build target
run: |
cd ${{ env.BUILD_DIR }}
make target/compile -j1 V=s  # 目标编译单线程避免冲突
 
---------------------------------------------------------
 
13. Build Packages (包编译)
 
---------------------------------------------------------
 
- name: Build packages
run: |
cd ${{ env.BUILD_DIR }}
make package/compile -j2 V=s
make package/install -j2 V=s
make package/index
 
---------------------------------------------------------
 
14. Build Firmware (多线程失败自动降级)
 
---------------------------------------------------------
 
- name: Build firmware
run: |
cd ${{ env.BUILD_DIR }}
先尝试 2 线程，失败则单线程排查问题
 
make -j2 V=s || make -j1 V=s
 
---------------------------------------------------------
 
15. Verify Firmware (完整性校验)
 
---------------------------------------------------------
 
- name: Verify firmware output
run: |
cd ${{ env.BUILD_DIR }}
echo "=== Firmware Files List ==="
ls -lh {{ env.TARGET_DIR }}/*{{ env.PROFILE }}* || { echo "Firmware not found!"; exit 1; }echo -e "\n=== Firmware MD5 Checksum ==="
md5sum {{ env.TARGET_DIR }}/*{{ env.PROFILE }}* || trueecho -e "\n=== Firmware File Type Check ==="
for bin in {{ env.TARGET_DIR }}/*{{ env.PROFILE }}*.bin; do
file $bin || true
done
 
---------------------------------------------------------
 
16. Upload Artifacts (临时存储)
 
---------------------------------------------------------
 
- name: Upload artifacts
uses: actions/upload-artifact@v4
with:
name: immortalwrt-{{ env.PROFILE }}-build-{{ github.run_number }}
path: |
{{ env.TARGET_DIR }}/**/*{{ env.PROFILE }}*
${{ env.BUILD_DIR }}/logs/failed_patches/*
retention-days: 7
 
---------------------------------------------------------
 
17. Publish to Release (正式交付)
 
---------------------------------------------------------
 
- name: Publish firmware to Release
uses: softprops/action-gh-release@v2
with:
tag_name: v{{ github.run_number }}
name: ImmortalWrt SL3000 eMMC 旗舰版 Firmware v{{ github.run_number }}
body: |
## 构建信息
- 设备型号：SL3000 eMMC Ultimate Edition
- 内核版本：Linux 6.12.63
- 构建时间：${{ github.sha_short }}
- 包含功能：
- WiFi 6 (MT7981) + WED 硬件加速
- 2.5G 以太网 (MT7531 交换机)
- eMMC HS400 高速存储
- Docker + Dockerman 管理
- PassWall2 + Xray 科学上网
- 完整 GPIO/LED/按键支持
files: |
{{ env.TARGET_DIR }}/**/*{{ env.PROFILE }}*
draft: false
prerelease: false
 
---------------------------------------------------------
 
18. Post-build Cleanup (释放空间)
 
---------------------------------------------------------
 
- name: Post-build Disk Cleanup
if: always()
run: |
cd ${{ env.BUILD_DIR }}
sudo rm -rf tmp build_dir staging_dir logs/failed_patches
df -h