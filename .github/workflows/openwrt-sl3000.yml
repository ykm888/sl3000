name: Build SL3000-EMMC Firmware
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      PROFILE: sl3000-emmc
      DTS_NAME: mt7981b-sl3000-emmc
      DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile
      MK_FILE: target/linux/mediatek/image/filogic.mk
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: Cache dl, build_dir, staging_dir
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','**/*.mk','**/*.dts','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 \
            rsync unzip wget git zlib1g-dev file m4 swig

      - name: Force rebuild host toolchain
        run: rm -rf staging_dir/host staging_dir/hostpkg build_dir/host build_dir/hostpkg

      - name: Feeds auto repair
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools and toolchain
        run: |
          make tools/install -j"$(nproc)" V=s
          make toolchain/install -j"$(nproc)" V=s

      - name: DTS/mk sanity check
        run: |
          set -e
          [ -f "${DTS_FILE}" ] || { echo "❌ Missing DTS_FILE"; exit 1; }
          [ -f "${DTS_MK}" ] || { echo "❌ Missing DTS_MK"; exit 1; }
          [ -f "${MK_FILE}" ] || { echo "❌ Missing MK_FILE"; exit 1; }
          grep -q "${DTS_NAME}.dtb" "${DTS_MK}" || { echo "❌ DTS_MK lacks dtb entry"; exit 1; }
          echo "✅ DTS/mk sanity passed"

      - name: Align target profile in .config
        run: |
          sed -i '/^CONFIG_TARGET_/d' .config 2>/dev/null || true
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y" >> .config
          make defconfig

      - name: Patch dry-run check
        run: |
          PATCH_DIRS=$(ls -d target/linux/mediatek/patches-* 2>/dev/null || true)
          if [ -n "${PATCH_DIRS}" ]; then
            find ${PATCH_DIRS} -name '*.patch' -exec sh -c 'patch -p1 --dry-run -f < "$1"' _ {} \;
          fi

      - name: DTS compile + dtb detect
        run: |
          make target/linux/compile -j"$(nproc)" V=s
          DTB_PATH=$(find build_dir -type f -name "${DTS_NAME}.dtb" | head -n 1 || true)
          [ -n "${DTB_PATH}" ] || { echo "❌ DTS compiled but dtb not found"; exit 1; }
          echo "✅ Found dtb: ${DTB_PATH}"

      - name: Build firmware with auto-repair
        run: |
          set -e
          build_once() { make -j"$(nproc)" V=s; }
          if ! build_once; then
            rm -rf build_dir
            if ! build_once; then
              rm -rf dl build_dir staging_dir tmp
              build_once
            fi
          fi

      - name: Verify firmware outputs
        run: |
          set -e
          ls -lh "$TARGET_DIR"
          if compgen -G "$TARGET_DIR/*.bin" > /dev/null; then
            echo "✅ Found .bin files"
          else
            echo "❌ No .bin files found"; exit 1
          fi
          if compgen -G "$TARGET_DIR/*sysupgrade.bin" > /dev/null; then
            echo "✅ sysupgrade present"
          else
            echo "❌ Missing sysupgrade.bin"; exit 1
          fi

      - name: Package firmware outputs
        run: |
          tar -czf "${TARGET_DIR}/sl3000-emmc-firmware.tar.gz" -C "$TARGET_DIR" .
          (cd "$TARGET_DIR" && sha256sum * > firmware-sha256.txt)
          ls -lh "${TARGET_DIR}/"*

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt
          if-no-files-found: error

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/sl3000-emmc-firmware.tar.gz
            ${{ env.TARGET_DIR }}/firmware-sha256.txt
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: SL3000-EMMC Build ${{ github.run_number }}
          body: |
            Profile: sl3000-emmc
            DTS: ${{ env.DTS_FILE }}
            DTS Makefile: ${{ env.DTS_MK }}
            Commit: ${{ github.sha }}

      - name: Pack logs on failure
        if: failure()
        run: |
          mkdir -p logs || true
          tar -czf build-logs.tar.gz logs/

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs.tar.gz
          if-no-files-found: ignore