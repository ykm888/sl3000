name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      PROFILE: sl3000-emmc
      DTS_NAME: mt7981b-sl3000-emmc
      DTS_FILE: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      DTS_MK: target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/Makefile
      MK_FILE: target/linux/mediatek/image/filogic.mk
      TARGET_DIR: bin/targets/mediatek/filogic

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          df -h

      - name: Cache dl, build_dir, staging_dir
        uses: actions/cache@v4
        with:
          path: |
            dl
            build_dir
            staging_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','**/*.mk','**/*.dts','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 \
            rsync unzip wget git zlib1g-dev file m4

      - name: Force rebuild host toolchain
        run: |
          rm -rf staging_dir/host staging_dir/hostpkg build_dir/host build_dir/hostpkg

      - name: Feeds auto repair
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build tools and toolchain
        run: |
          make tools/install -j"$(nproc)" V=s
          make toolchain/install -j"$(nproc)" V=s

      - name: Auto-create DTS Makefile if missing
        run: |
          if [ ! -f "$DTS_MK" ]; then
            echo "âš ï¸ DTS Makefile ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º"
            mkdir -p "$(dirname "$DTS_MK")"
            echo "dtb-\$(CONFIG_ARCH_MEDIATEK) += ${DTS_NAME}.dtb" > "$DTS_MK"
          fi

          if ! grep -q "${DTS_NAME}.dtb" "$DTS_MK"; then
            echo "âš ï¸ DTS Makefile ç¼ºå°‘ sl3000 dtb æ³¨å†Œï¼Œè‡ªåŠ¨è¿½åŠ "
            echo "dtb-\$(CONFIG_ARCH_MEDIATEK) += ${DTS_NAME}.dtb" >> "$DTS_MK"
          fi

          echo "ğŸ“Œ DTS Makefile å·²å¯¹é½"

      - name: Auto-align DTS / mk / profile
        run: |
          echo "=== è‡ªåŠ¨å¯¹é½ DTS / mk / profile ä¸‰ä»¶å¥— ==="

          if [ ! -f "$DTS_FILE" ]; then
            echo "âŒ DTS æ–‡ä»¶ä¸å­˜åœ¨ï¼š$DTS_FILE"
            exit 1
          fi

          DEVICE_DTS="${DTS_NAME}"

          # ä¿®å¤ mk
          sed -i "s|DEVICE_DTS :=.*|DEVICE_DTS := ${DEVICE_DTS}|" "$MK_FILE"
          sed -i "s|DEVICE_DTS_DIR :=.*|DEVICE_DTS_DIR := \$(DTS_DIR)/mediatek|" "$MK_FILE"

          # ä¿®å¤ .config
          sed -i '/^CONFIG_TARGET_/d' .config 2>/dev/null || true
          echo "CONFIG_TARGET_mediatek=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
          echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y" >> .config

          make defconfig

          echo "ğŸ‰ ä¸‰ä»¶å¥—å·²å®Œå…¨å¯¹é½"

      - name: Patch auto check
        run: |
          PATCH_DIRS=$(ls -d target/linux/mediatek/patches-* 2>/dev/null || true)
          if [ -z "$PATCH_DIRS" ]; then
            echo "â„¹ï¸ æ— è¡¥ä¸ç›®å½•ï¼Œè·³è¿‡ patch æ£€æŸ¥"
            exit 0
          fi
          echo "â„¹ï¸ æ£€æŸ¥è¡¥ä¸æ˜¯å¦èƒ½å¹²å‡€åº”ç”¨..."
          find $PATCH_DIRS -name '*.patch' \
            -exec sh -c 'patch -p1 --dry-run -f < "$1"' _ {} \;

      - name: DTS compile check + dtb auto-detect
        run: |
          make target/linux/compile -j"$(nproc)" V=s

          echo "=== æœç´¢æ‰€æœ‰ dtb æ–‡ä»¶ ==="
          find build_dir -type f -name "*.dtb" || true

          DTB_PATH=$(find build_dir -type f -name "${DTS_NAME}.dtb" | head -n 1 || true)

          if [ -z "$DTB_PATH" ]; then
            echo "âŒ DTS å·²ç¼–è¯‘ï¼Œä½†æœªæ‰¾åˆ° sl3000 ç›¸å…³ dtb"
            exit 1
          fi

          echo "âœ… DTS å·²ç¼–è¯‘ä¸º dtb: $DTB_PATH"

      - name: Build firmware with auto-repair
        run: |
          set -e
          build_once() { make -j"$(nproc)" V=s; }
          if ! build_once; then
            echo "âš ï¸ æ„å»ºå¤±è´¥ï¼Œæ¸…ç† build_dir é‡è¯•"
            rm -rf build_dir
            if ! build_once; then
              echo "âš ï¸ å†æ¬¡å¤±è´¥ï¼Œæ¸…ç† dl + build_dir + staging_dir + tmp å†è¯•"
              rm -rf dl build_dir staging_dir tmp
              build_once
            fi
          fi

      - name: Verify firmware output
        run: |
          ls -lh "$TARGET_DIR"
          test -s ${TARGET_DIR}/*.bin

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: ${{ env.TARGET_DIR }}/*

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARGET_DIR }}/*
          tag_name: sl3000-emmc-${{ github.run_number }}
          name: SL3000-EMMC Build ${{ github.run_number }}
          body: |
            - Profile: sl3000-emmc
            - DTS: ${{ env.DTS_FILE }}
            - DTS Makefile: ${{ env.DTS_MK }}
            - Commit: ${{ github.sha }}

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            logs/
            build_dir/
            staging_dir/