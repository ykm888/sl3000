name: ImmortalWrt Build
on:
  workflow_dispatch:

permissions:
  contents: write

env:
  PROFILE: sl3000-emmc
  DTS_NAME: mt7981b-sl3000-emmc
  TARGET_DIR: bin/targets/mediatek/filogic

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ===========================
      # 1. 拉取官方 ImmortalWrt 源码
      # ===========================
      - name: Checkout official ImmortalWrt
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          ref: master
          fetch-depth: 0

      # ===========================
      # 2. 拉取你仓库的三件套
      # ===========================
      - name: Checkout your repo (三件套)
        uses: actions/checkout@v4
        with:
          path: myrepo

      - name: Apply your DTS/mk/config 三件套
        run: |
          echo "=== Apply DTS ==="
          cp myrepo/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts \
             target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/

          echo "=== Apply filogic.mk ==="
          cp myrepo/target/linux/mediatek/image/filogic.mk \
             target/linux/mediatek/image/

          echo "=== Apply .config (base) ==="
          cp myrepo/.config .config

      # ===========================
      # 3. 安装依赖
      # ===========================
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev file wget curl git coreutils \
            ccache time pkg-config libelf-dev rsync tar jq ca-certificates device-tree-compiler

      # ===========================
      # 4. 清理缓存（彻底）
      # ===========================
      - name: Clean build cache
        run: |
          rm -rf build_dir staging_dir tmp
          rm -rf dl/*.tmp || true
          find . -name "*.rej" -delete
          find . -name "*.orig" -delete
          make clean
          make dirclean

      # ===========================
      # 5. 过滤补丁（只保留 mt7981/filogic）
      # ===========================
      - name: Filter patches
        run: |
          cd target/linux/mediatek/patches-6.12
          for f in *; do
            case "$f" in
              *7981*|*filogic*|*mediatek*|*generic* )
                echo "Keep: $f"
                ;;
              * )
                echo "Remove: $f"
                rm -f "$f"
                ;;
            esac
          done

      # ===========================
      # 6. Feeds
      # ===========================
      - name: Feeds update/install
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ===========================
      # 7. olddefconfig（绝不触发 menuconfig）
      # ===========================
      - name: Configure target (non-interactive)
        run: |
          echo "=== Force non-interactive config ==="
          make olddefconfig

      # ===========================
      # 8. 构建固件
      # ===========================
      - name: Build firmware
        run: |
          make -j"$(nproc)" || make -j1 V=s

      # ===========================
      # 9. 验证产物
      # ===========================
      - name: Verify output
        run: |
          ls -lh "${{ env.TARGET_DIR }}"
          compgen -G "${{ env.TARGET_DIR }}/*sysupgrade.bin" > /dev/null || { echo "❌ Missing sysupgrade.bin"; exit 1; }

      # ===========================
      # 10. 上传固件
      # ===========================
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}
          path: |
            ${{ env.TARGET_DIR }}/*sysupgrade.bin
            ${{ env.TARGET_DIR }}/*initramfs-kernel.bin
            ${{ env.TARGET_DIR }}/*.manifest
            ${{ env.TARGET_DIR }}/*.buildinfo
            ${{ env.TARGET_DIR }}/profiles.json