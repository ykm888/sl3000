name: ImmortalWrt SL3000 Engineering Build

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_DIR: bin/targets/mediatek/filogic
  BUILD_DIR: openwrt
  CCACHE_DIR: ccache

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # ---------------------------------------------------------
      # 0. 基础准备：拉代码 + 磁盘清理
      # ---------------------------------------------------------
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Pre-build Disk Optimization
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo docker system prune -af || true
          df -h

      - name: Prepare build directory
        run: |
          mkdir -p "${{ env.BUILD_DIR }}"
          rsync -a --delete ./ "${{ env.BUILD_DIR }}/"
          df -h

      # ---------------------------------------------------------
      # 1. 构建环境：依赖 + ccache + 缓存
      # ---------------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 unzip zlib1g-dev \
            file wget curl git ccache time pkg-config libelf-dev \
            rsync tar jq ca-certificates device-tree-compiler

      - name: Setup ccache
        run: |
          mkdir -p "${{ env.CCACHE_DIR }}"
          echo "CCACHE_DIR=${{ env.CCACHE_DIR }}" >> "$GITHUB_ENV"
          export CCACHE_DIR="${{ env.CCACHE_DIR }}"
          ccache --max-size=5G
          ccache -z

      - name: Restore caches
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CCACHE_DIR }}
            ${{ env.BUILD_DIR }}/dl
            ${{ env.BUILD_DIR }}/staging_dir/toolchain-*
            ${{ env.BUILD_DIR }}/build_dir/toolchain-*
          key: immortalwrt-${{ github.run_id }}
          restore-keys: |
            immortalwrt-toolchain-
            immortalwrt-base-

      # ---------------------------------------------------------
      # 2. 自动检测 & 注册三件套
      # ---------------------------------------------------------
      - name: Auto Detect & Register 3-piece
        run: |
          cd "${{ env.BUILD_DIR }}"
          MK_FILE=target/linux/mediatek/image/filogic.mk
          PROFILE=$(grep -E "^define Device/" "$MK_FILE" | awk '{print $2}' | head -1)
          DTS_NAME=$(grep -E "^[[:space:]]*DEVICE_DTS[[:space:]]*:=" "$MK_FILE" | head -1 | awk -F':=' '{print $2}' | xargs)
          DTS_DIR=$(grep -E "^[[:space:]]*DEVICE_DTS_DIR[[:space:]]*:=" "$MK_FILE" | head -1 | awk -F':=' '{print $2}' | xargs)
          DTS_FILE="$DTS_DIR/$DTS_NAME.dts"

          echo "PROFILE=$PROFILE" >> $GITHUB_ENV
          echo "DTS_NAME=$DTS_NAME" >> $GITHUB_ENV
          echo "DTS_FILE=$DTS_FILE" >> $GITHUB_ENV
          echo "MK_FILE=$MK_FILE" >> $GITHUB_ENV

          echo "=== Auto-Detected 3-piece ==="
          echo "PROFILE=$PROFILE"
          echo "DTS_NAME=$DTS_NAME"
          echo "DTS_FILE=$DTS_FILE"
          echo "MK_FILE=$MK_FILE"

      # ---------------------------------------------------------
      # 3. Feeds & 工具链（强制清理缓存）
      # ---------------------------------------------------------
      - name: Setup feeds
        run: |
          cd "${{ env.BUILD_DIR }}"
          rm -rf feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clean toolchain before build
        run: |
          cd "${{ env.BUILD_DIR }}"
          rm -rf build_dir/toolchain-* staging_dir/toolchain-*

      - name: Build tools
        run: |
          cd "${{ env.BUILD_DIR }}"
          make tools/install -j$(nproc) V=s

      - name: Build toolchain
        run: |
          cd "${{ env.BUILD_DIR }}"
          make toolchain/install -j$(nproc) V=s

      # ---------------------------------------------------------
      # 4. DTS 校验：此时 tools + toolchain 已就绪
      # ---------------------------------------------------------
      - name: DTS validation via OpenWrt kernel-dtc
        run: |
          cd "${{ env.BUILD_DIR }}"
          mkdir -p logs/dts
          echo "=== [DTS Header Preview] ==="
          head -15 "${{ env.DTS_FILE }}" || true
          echo "=== [DTS Validation] ==="
          if ! make target/linux/compile CHECK=1 V=s -j1; then
            echo "❌ DTS validation failed"
            hexdump -C "${{ env.DTS_FILE }}" | head -40 || true
            exit 1
          fi
          echo "✅ DTS validation passed"

      # ---------------------------------------------------------
      # 5. Target & Packages & Image
      # ---------------------------------------------------------
      - name: Build target
        run: |
          cd "${{ env.BUILD_DIR }}"
          make target/compile -j1 V=s

      - name: Build packages
        run: |
          cd "${{ env.BUILD_DIR }}"
          make package/compile -j$(nproc) V=s
          make package/install -j$(nproc) V=s
          make package/index

      - name: Build firmware image
        run: |
          cd "${{ env.BUILD_DIR }}"
          make image PROFILE="${{ env.PROFILE }}" -j$(nproc) V=s || \
          make image PROFILE="${{ env.PROFILE }}" -j1 V=s

      # ---------------------------------------------------------
      # 6. 固件验证 + 自动注册产物
      # ---------------------------------------------------------
      - name: Verify firmware output
        run: |
          cd "${{ env.BUILD_DIR }}"
          echo "=== [Firmware List] ==="
          ls -lh "${{ env.TARGET_DIR }}/${{ env.PROFILE }}" || { echo "❌ No firmware found"; exit 1; }
          echo "=== [MD5 Checksum] ==="
          md5sum "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"/* || true
          echo "=== [SHA256 Checksum] ==="
          sha256sum "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"/* || true
          echo "=== [File Type Check] ==="
          for bin in "${{ env.TARGET_DIR }}/${{ env.PROFILE }}"/*; do
            file "$bin" || true
          done
          echo "✅ Firmware validation passed"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-${{ env.PROFILE }}-build-${{ github.run_number }}
          path: |
            ${{ env.TARGET_DIR }}/${{ env.PROFILE }}
            ${{ env.BUILD_DIR }}/logs/dts
