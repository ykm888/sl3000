name: Build SL3000-EMMC Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/boost
          df -h

      - name: Mount tmpfs
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo mount -t tmpfs -o size=100G tmpfs /mnt/openwrt
          sudo chown -R $USER:$USER /mnt/openwrt

      - name: Setup deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk libncurses5-dev libncursesw5-dev \
            zlib1g-dev libssl-dev wget git python3 unzip rsync file

      - name: Sync repo to /mnt/openwrt
        run: |
          tar --exclude=.git -cf - . | (cd /mnt/openwrt && tar xpf -)
          cd /mnt/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Try apply patches if present
        working-directory: /mnt/openwrt
        run: |
          set -e
          shopt -s nullglob
          PATCHES=(patches/*.patch)
          if [ ${#PATCHES[@]} -gt 0 ]; then
            echo "Found ${#PATCHES[@]} patches, trying to apply..."
            # Try git apply first (works with git-format-patch). Falls back to patch -p1.
            ok=0
            for p in "${PATCHES[@]}"; do
              echo "Applying $p (git apply)"
              if git apply "$p" 2>/dev/null; then
                ok=1
              else
                echo "git apply failed, trying patch -p1 on $p"
                if patch -p1 < "$p"; then
                  ok=1
                else
                  echo "Patch failed: $p"
                fi
              fi
            done
            if [ $ok -eq 0 ]; then
              echo "All patches failed, will fallback to overwrite."
            fi
          else
            echo "No patches found, will fallback to overwrite."
          fi

      - name: Fallback overwrite three-piece (always ensures correctness)
        working-directory: /mnt/openwrt
        run: |
          # Overwrite DTS
          cat > target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts <<'EOF'
          /dts-v1/;

          #include "mt7981.dtsi"

          / {
            model = "SL3000 EMMC";
            compatible = "sl,sl3000-emmc", "mediatek,mt7981";

            chosen { bootargs = "console=ttyS0,115200n8"; };

            memory { device_type = "memory"; reg = <0x40000000 0x20000000>; };
          };

          &uart0 { status = "okay"; };
          &eth   { status = "okay"; };
          &mmc0  { status = "okay"; };
          EOF

          # Overwrite MK
          cat > target/linux/mediatek/image/filogic.mk <<'EOF'
          define Device/sl3000-emmc
            DEVICE_VENDOR := SL
            DEVICE_MODEL := 3000
            DEVICE_VARIANT := EMMC
            DEVICE_DTS := mt7981b-sl3000-emmc
            SUPPORTED_DEVICES := sl3000-emmc
            DEVICE_PACKAGES := kmod-usb3 kmod-mt76 kmod-mt7981-firmware mt7981-wo-firmware
            IMAGES := sysupgrade.bin
            KERNEL := kernel-bin | lzma | fit lzma $(KDIR)/image-$(firstword $(DEVICE_DTS)).dtb
            KERNEL_INITRAMFS := kernel-bin | lzma | \
                  fit lzma $(KDIR)/image-$(firstword $(DEVICE_DTS)).dtb with-initrd | pad-to 64k
            IMAGE/sysupgrade.bin := sysupgrade-tar | append-metadata
          endef
          TARGET_DEVICES += sl3000-emmc
          EOF

          # Overwrite CONFIG
          cat > .config <<'EOF'
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          EOF

          make defconfig

      - name: Verify three-piece
        working-directory: /mnt/openwrt
        run: |
          test -f target/linux/mediatek/dts/mt7981b-sl3000-emmc.dts || (echo "❌ DTS 缺失"; exit 1)
          grep -q 'sl3000-emmc' target/linux/mediatek/image/filogic.mk || (echo "❌ MK 条目缺失"; exit 1)
          grep -q 'sl3000-emmc' .config || (echo "❌ CONFIG 缺失"; exit 1)

      - name: Build tools
        working-directory: /mnt/openwrt
        run: make tools/install -j$(nproc) V=s

      - name: Build toolchain
        working-directory: /mnt/openwrt
        run: make toolchain/install -j$(nproc) V=s

      - name: Build firmware
        working-directory: /mnt/openwrt
        run: |
          set -eo pipefail
          make -j$(nproc) || { echo "并行失败，回退单线程"; make -j1 V=s; }

      - name: Check output
        working-directory: /mnt/openwrt
        run: |
          ls bin/targets/**/sl3000-emmc/*.bin || (echo "❌ 固件未生成"; exit 1)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.bin
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.manifest
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.buildinfo
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.json