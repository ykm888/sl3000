name: Build SL3000-EMMC Firmware

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BUILD_DIR: /home/runner/work/openwrt
      TARGET_DIR: /home/runner/work/openwrt/bin/targets/mediatek/filogic
      DTS_PATH: /home/runner/work/openwrt/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts
      MK_PATH: /home/runner/work/openwrt/target/linux/mediatek/image/filogic.mk
      PROFILE: sl3000-emmc

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Move source to large disk (60GB)
        run: |
          mkdir -p $BUILD_DIR
          rsync -a ./ $BUILD_DIR/

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          docker system prune -af || true
          sudo rm -rf /var/lib/apt/lists/* || true

      - name: Cache dl and build_dir
        uses: actions/cache@v4
        with:
          path: |
            $BUILD_DIR/dl
            $BUILD_DIR/build_dir
          key: ${{ runner.os }}-openwrt-${{ github.ref }}-${{ hashFiles('feeds.conf','package/**/*','target/**/*','toolchain/**/*','tools/**/*','.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ github.ref }}-
            ${{ runner.os }}-openwrt-

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison gawk gettext \
            libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip wget git zlib1g-dev file

      - name: Verify three-piece set
        run: |
          cd $BUILD_DIR
          test -f .config || (echo "❌ .config missing" && exit 1)
          test -f "${DTS_PATH}" || (echo "❌ DTS missing" && exit 1)
          grep -q "${PROFILE}" "${MK_PATH}" || (echo "❌ mk missing profile" && exit 1)

      - name: Ensure profile registered in mk
        run: |
          cd $BUILD_DIR
          if ! grep -q "TARGET_DEVICES += ${PROFILE}" "${MK_PATH}"; then
            echo "TARGET_DEVICES += ${PROFILE}" >> "${MK_PATH}"
          fi

      - name: Prepare .config
        run: |
          cd $BUILD_DIR
          cp .config .config.backup
          sed -i '/CONFIG_TARGET_mediatek_filogic_DEVICE_/d' .config
          {
            echo "CONFIG_TARGET_mediatek=y"
            echo "CONFIG_TARGET_mediatek_filogic=y"
            echo "CONFIG_TARGET_mediatek_filogic_DEVICE_${PROFILE}=y"
          } >> .config
          grep -v 'CONFIG_TARGET_mediatek_filogic_DEVICE_' .config.backup >> .config
          make defconfig

      - name: Build firmware with auto-repair
        run: |
          cd $BUILD_DIR
          make -j$(nproc) V=s || (
            echo "⚠️ 构建失败，清理 build_dir 重试"
            rm -rf build_dir
            make -j$(nproc) V=s || (
              echo "⚠️ 二次失败，清理 dl+tmp 再试"
              rm -rf dl build_dir tmp
              make -j$(nproc) V=s
            )
          )

      - name: Upload firmware artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ${PROFILE}-firmware
          path: ${{ env.TARGET_DIR }}/*

      - name: Publish GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.TARGET_DIR }}/*
          tag_name: ${PROFILE}-${{ github.run_number }}
          name: ${PROFILE} Firmware Build ${{ github.run_number }}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: $BUILD_DIR/logs/
          if-no-files-found: warn