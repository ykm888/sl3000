name: Build SL3000-EMMC Firmware

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /usr/local/share/boost
          df -h

      - name: Allocate 100G disk space on /mnt/openwrt
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo mount -t tmpfs -o size=100G tmpfs /mnt/openwrt
          df -h /mnt/openwrt

      - name: Setup build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison gawk libncurses5-dev libncursesw5-dev \
            zlib1g-dev libssl-dev wget git python3 unzip rsync file

      - name: Prepare OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git /mnt/openwrt
          cd /mnt/openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Cache OpenWrt dl
        uses: actions/cache@v4
        with:
          path: /mnt/openwrt/dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-

      - name: Cache OpenWrt build
        uses: actions/cache@v4
        with:
          path: |
            /mnt/openwrt/staging_dir
            /mnt/openwrt/build_dir
          key: ${{ runner.os }}-openwrt-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-build-

      - name: Copy custom DTS and mk
        run: |
          cp target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts /mnt/openwrt/target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/
          cp target/linux/mediatek/image/filogic.mk /mnt/openwrt/target/linux/mediatek/image/

      - name: Load config
        run: |
          cp .config /mnt/openwrt/.config

      - name: Expand config
        working-directory: /mnt/openwrt
        run: make defconfig

      - name: Verify three-piece registration
        working-directory: /mnt/openwrt
        run: |
          test -f target/linux/mediatek/files-6.12/arch/arm64/boot/dts/mediatek/mt7981b-sl3000-emmc.dts || (echo "❌ DTS MISSING!"; exit 1)
          grep -q 'Device/sl3000-emmc' target/linux/mediatek/image/filogic.mk || (echo "❌ MK ENTRY MISSING!"; exit 1)
          grep -q 'CONFIG_TARGET_mediatek_filogic_DEVICE_sl3000-emmc=y' .config || (echo "❌ CONFIG MISSING!"; exit 1)

      - name: Build host tools
        working-directory: /mnt/openwrt
        run: make tools/install -j$(nproc) V=s

      - name: Build cross toolchain
        working-directory: /mnt/openwrt
        run: make toolchain/install -j$(nproc) V=s

      - name: Sanity check toolchain
        working-directory: /mnt/openwrt
        run: |
          TOOLDIR=$(echo staging_dir/toolchain-*/bin)
          test -d "$TOOLDIR" || (echo "❌ Toolchain bin missing"; exit 1)
          for tool in aarch64-openwrt-linux-musl-gcc make-ext4fs mkimage mksquashfs; do
            find staging_dir -name "*$tool*" | grep -q . || (echo "❌ Tool $tool missing"; exit 1)
          done

      - name: Build firmware
        working-directory: /mnt/openwrt
        run: |
          set -eo pipefail
          make -j$(nproc) || { echo "⚠️ 并行构建失败，尝试单线程重试..."; make -j1 V=s; }

      - name: Check firmware output
        working-directory: /mnt/openwrt
        run: |
          ls bin/targets/**/sl3000-emmc/*.bin || (echo "❌ 固件未生成"; exit 1)

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-emmc-firmware
          path: |
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.bin
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.manifest
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.buildinfo
            /mnt/openwrt/bin/targets/**/sl3000-emmc/*.json

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: sl3000-emmc-${{ github.run_number }}
          release_name: SL3000-EMMC Firmware ${{ github.run_number }}
          draft: false
          prerelease: false

      - name: Upload firmware to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /mnt/openwrt/bin/targets/**/sl3000-emmc/openwrt-*.bin
          asset_name: openwrt-sl3000-emmc.bin
          asset_content_type: application/octet-stream

      - name: Generate SHA256 checksum
        working-directory: /mnt/openwrt/bin/targets
        run: |
          find . -name "openwrt-*.bin" -exec sha256sum {} \; > SHA256SUMS

      - name: Upload checksum to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: /mnt/openwrt/bin/targets/**/sl3000-emmc/SHA256SUMS
          asset_name: SHA256SUMS
          asset_content_type: text/plain