name: Build SL3000 eMMC (24.10)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Clean Disk
      run: |
        docker system prune -af || true
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache
        sudo mkdir -p /mnt/immortalwrt
        sudo chown $USER:$USER /mnt/immortalwrt

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-distutils rsync unzip zlib1g-dev file wget ccache \
          device-tree-compiler

    - name: Clone ImmortalWrt 24.10
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git /mnt/immortalwrt
        cd /mnt/immortalwrt
        # 你自己锁定的 24.10 提交/分支，自行替换
        # 示例：git checkout v24.10.0
        # 如果你有具体 commit，就在这里写死
        # git checkout <your-24.10-commit>
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Copy SL3000 24.10 Triple Set
      run: |
        cd $GITHUB_WORKSPACE

        # 三件套：完全使用你仓库里的内容
        cp -f image/filogic.mk /mnt/immortalwrt/target/linux/mediatek/image/
        cp -f dts/mt7981b-sl3000-emmc.dts /mnt/immortalwrt/target/linux/mediatek/dts/
        cp -f .config /mnt/immortalwrt/.config

        # 自检脚本
        mkdir -p /mnt/immortalwrt/scripts
        cp -f scripts/check-sl3000-24.10.sh /mnt/immortalwrt/scripts/

    - name: Run SL3000 24.10 Self Check
      run: |
        cd /mnt/immortalwrt
        chmod +x scripts/check-sl3000-24.10.sh
        scripts/check-sl3000-24.10.sh

    - name: Build Firmware
      run: |
        cd /mnt/immortalwrt
        make defconfig
        make -j$(nproc) || make -j1 V=s

    - name: Collect Output
      run: |
        mkdir -p $GITHUB_WORKSPACE/output
        cp /mnt/immortalwrt/bin/targets/mediatek/filogic/*sl3000* $GITHUB_WORKSPACE/output/ || true
        cp /mnt/immortalwrt/bin/targets/mediatek/filogic/sha256sums $GITHUB_WORKSPACE/output/ || true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-emmc-24.10
        path: output
