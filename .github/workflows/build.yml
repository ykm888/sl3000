name: Build ImmortalWrt S13000 (24.10 Extreme)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Extreme disk clean (keep ImmortalWrt and caches)
      run: |
        # 系统级大块清理（不动 /home/runner/immortalwrt）
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/powershell
        sudo rm -rf /usr/local/share/chromium
        sudo rm -rf /usr/local/share/miniconda
        sudo rm -rf /usr/local/share/swift
        sudo rm -rf /usr/local/share/edge
        sudo rm -rf /usr/local/share/az_*
        sudo rm -rf /usr/local/share/gradle*
        sudo rm -rf /usr/local/share/maven*
        # 用户级缓存清理
        sudo rm -rf ~/.npm || true
        sudo rm -rf ~/.cargo || true
        sudo rm -rf ~/.cache/pip || true
        # Docker 与 apt 缓存
        sudo docker image prune -a -f || true
        sudo apt clean
        echo "[INFO] Disk usage after clean:"
        df -h

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget ccache

    - name: Clone ImmortalWrt 24.10
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git \
          -b openwrt-24.10 /home/runner/immortalwrt

    # ============================
    #        缓存恢复
    # ============================

    - name: Restore ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}
        restore-keys: |
          ccache-${{ runner.os }}-

    - name: Restore dl cache
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}
        restore-keys: |
          dl-${{ runner.os }}-

    - name: Restore staging_dir cache
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/staging_dir
        key: staging-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}
        restore-keys: |
          staging-${{ runner.os }}-

    # ============================
    #        准备 & 检查
    # ============================

    - name: Remove broken MT7986 patch
      run: |
        rm -f /home/runner/immortalwrt/target/linux/mediatek/patches-6.6/999-fix-mt7986.patch || true

    - name: Prepare S13000 triple-set
      run: |
        chmod +x scripts/prepare_s13000.sh
        scripts/prepare_s13000.sh

    - name: Check S13000 DTS/mk/config
      run: |
        chmod +x scripts/check_s13000.sh
        scripts/check_s13000.sh

    # ============================
    #        构建固件
    # ============================

    - name: Build firmware
      run: |
        cd /home/runner/immortalwrt
        echo "[INFO] Disk usage before build:"
        df -h

        export CCACHE_DIR=~/.ccache
        export CC="ccache gcc"
        export CXX="ccache g++"

        make defconfig
        echo "[INFO] Build running..."
        make -j$(nproc) || make -j1 V=s

        echo "[INFO] Disk usage after build:"
        df -h
        ccache -s || true

    # ============================
    #        保存缓存
    # ============================

    - name: Save ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ccache-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}

    - name: Save dl cache
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/dl
        key: dl-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}

    - name: Save staging_dir cache
      uses: actions/cache@v4
      with:
        path: /home/runner/immortalwrt/staging_dir
        key: staging-${{ runner.os }}-${{ hashFiles('configs/**/*.config', 'scripts/**/*.sh') }}

    # ============================
    #        收集固件
    # ============================

    - name: Collect firmware
      run: |
        mkdir -p output
        cp -rf /home/runner/immortalwrt/bin/targets/*/*/* output/ || true
        echo "[INFO] Collected firmware files:"
        ls -lh output || true

    # ============================
    #        自动发布 Release
    # ============================

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: s13000-24.10-${{ github.run_number }}
        name: "S13000 Firmware Build #${{ github.run_number }}"
        body: |
          自动构建固件（S13000 / ImmortalWrt 24.10）
          - 设备：s13000_emmc
          - DTS：mt7981b-s13000-emmc.dts
          - 构建编号：${{ github.run_number }}
          - 缓存：ccache + dl + staging_dir
          - 磁盘：极限清理（不动 ImmortalWrt 仓库及缓存目录）
        files: output/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
