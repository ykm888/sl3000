name: Cleanup Unrelated Patches

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-patches:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # å¿…é¡»å®Œæ•´æ£€å‡ºæ‰èƒ½æäº¤ä¿®æ”¹

      - name: Remove unrelated patches
        run: |
          echo "=== æ£€æŸ¥å¹¶åˆ é™¤ä¸ç›¸å…³è¡¥ä¸ ==="
          for p in target/linux/mediatek/patches-6.12/*.patch; do
            echo "ğŸ” æ£€æŸ¥è¡¥ä¸: $p"
            files=$(grep -E '^(---|\+\+\+) ' "$p" | awk '{print $2}' | sed 's/^a\///; s/^b\///')
            valid=true
            for f in $files; do
              if [ ! -f "$f" ]; then
                echo "âš ï¸ è¡¥ä¸ $p ä¿®æ”¹äº†ä¸å­˜åœ¨çš„æ–‡ä»¶: $f"
                valid=false
              fi
            done
            if [ "$valid" = false ]; then
              echo "ğŸ—‘ åˆ é™¤ä¸ç›¸å…³è¡¥ä¸: $p"
              rm -f "$p"
            else
              echo "âœ… ä¿ç•™æœ‰æ•ˆè¡¥ä¸: $p"
            fi
          done
          echo "=== è¡¥ä¸æ¸…ç†å®Œæˆ ==="

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add target/linux/mediatek/patches-6.12/*.patch
          if git commit -m "chore: cleanup unrelated patches"; then
            git push
          else
            echo "No changes to commit"
